<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="theme-color" content="#0f172a">
  <title>Guess It! V1.3.5</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Space+Grotesk:wght@300;500;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js" defer></script>

  <style>
    /* --- VARIABLES --- */
    :root {
      --bg: #f8fafc;
      --card: rgba(255, 255, 255, 0.95);
      --border: rgba(99, 102, 241, 0.15);
      --text: #0f172a;
      --text-muted: #64748b;
      --primary: #4f46e5;
      --primary-glow: rgba(79, 70, 229, 0.3);
      --accent: #f43f5e;
      --gold: #f59e0b;
      --crystal: #8b5cf6;
      --gem: #0ea5e9;
      --font-head: 'Space Grotesk', sans-serif;
      --font-body: 'Outfit', sans-serif;
      --modal-bg: #ffffff;
      --input-bg: #f1f5f9;
      --dock-bg: rgba(255, 255, 255, 0.98);
    }

    /* DARK MODE */
    body.dark-mode {
      --bg: #020617;
      --card: rgba(30, 41, 59, 0.95);
      --border: rgba(99, 102, 241, 0.3);
      --text: #f8fafc;
      --text-muted: #94a3b8;
      --input-bg: rgba(255, 255, 255, 0.05);
      --modal-bg: #0f172a;
      --dock-bg: rgba(15, 23, 42, 0.98);
    }

    /* THEMES */
    body[data-theme="Gold"] { --bg: #281c04; --card: rgba(60, 40, 10, 0.95); --primary: #d97706; --border: #fcd34d; }
    body[data-theme="Matrix"] { --bg: #000; --card: #0a0a0a; --primary: #00ff41; --border: #003b00; --text: #e0f2fe; --font-head: 'Courier New', monospace; }
    
    /* --- BASE --- */
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: var(--font-body); user-select: none; -webkit-tap-highlight-color: transparent; }
    body { background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; font-size: 14px; transition: background 0.3s, color 0.3s; position: relative; }

    /* --- ANIMATIONS & BG --- */
    .bg-fx { position: fixed; inset: 0; z-index: -1; background: radial-gradient(circle at 50% 0%, var(--primary-glow) 0%, transparent 70%); opacity: 0.8; pointer-events: none; }
    
    /* --- SPLASH CUBE --- */
    .splash { position: fixed; inset: 0; z-index: 9999; background: #020617; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s ease-out, visibility 0.5s; }
    .splash.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
    
    .cube-wrap { perspective: 800px; width: 60px; height: 60px; margin-bottom: 30px; }
    .cube { width: 100%; height: 100%; transform-style: preserve-3d; animation: spin 6s infinite linear; }
    .face { position: absolute; width: 60px; height: 60px; background: rgba(99,102,241,0.1); border: 2px solid var(--primary); display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; box-shadow: 0 0 20px var(--primary-glow); font-weight: 900; backface-visibility: visible; }
    
    .f1 { transform: translateZ(30px); } .f2 { transform: rotateY(180deg) translateZ(30px); }
    .f3 { transform: rotateY(90deg) translateZ(30px); } .f4 { transform: rotateY(-90deg) translateZ(30px); }
    .f5 { transform: rotateX(90deg) translateZ(30px); } .f6 { transform: rotateX(-90deg) translateZ(30px); }
    @keyframes spin { 0% { transform: rotateX(0) rotateY(0); } 100% { transform: rotateX(360deg) rotateY(360deg); } }

    /* --- LAYOUT --- */
    .app { max-width: 480px; margin: 0 auto; height: 100%; display: flex; flex-direction: column; opacity: 0; transition: opacity 0.5s; }
    .app.loaded { opacity: 1; }
    .content { flex: 1; overflow-y: auto; padding: 15px 15px 110px 15px; scroll-behavior: smooth; -webkit-overflow-scrolling: touch; }
    .content::-webkit-scrollbar { display: none; }

    /* --- COMPONENTS --- */
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 20px; padding: 18px; margin-bottom: 12px; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
    
    .btn { 
        background: var(--input-bg); color: var(--text); border: 1px solid var(--border); 
        padding: 12px; border-radius: 14px; font-weight: 700; cursor: pointer; width: 100%; 
        display: flex; align-items: center; justify-content: center; gap: 8px; 
        font-family: var(--font-head); font-size: 13px; text-transform: uppercase; 
        transition: transform 0.1s, background 0.2s; 
    }
    .btn:active { transform: scale(0.97); }
    .btn-primary { background: var(--primary); border-color: var(--primary); color: white; box-shadow: 0 4px 15px var(--primary-glow); }
    .btn-sm { padding: 6px 12px; font-size: 11px; width: auto; }
    
    .currency-pill { background: var(--input-bg); border: 1px solid var(--border); padding: 4px 10px; border-radius: 20px; font-size: 11px; display: flex; align-items: center; gap: 5px; font-weight: 700; }
    
    .mission-cat-bar { display: flex; gap: 5px; margin-bottom: 10px; overflow-x: auto; padding-bottom: 5px; }
    .mission-tab { padding: 6px 12px; border-radius: 20px; background: var(--input-bg); color: var(--text-muted); font-size: 11px; font-weight: bold; cursor: pointer; border: 1px solid transparent; white-space: nowrap; transition: 0.2s; }
    .mission-tab.active { background: var(--primary); color: white; }

    /* --- AVATAR & SHOP --- */
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
    
    .item-box { background: var(--input-bg); border: 1px solid var(--border); padding: 10px; border-radius: 16px; text-align: center; cursor: pointer; position: relative; transition: 0.2s; }
    .item-box:active { transform: scale(0.95); }
    .item-price { font-size: 10px; display: flex; align-items: center; justify-content: center; gap: 3px; margin-top: 5px; font-weight: bold; }
    .tag-owned { position: absolute; top: 5px; right: 5px; width: 8px; height: 8px; background: #10b981; border-radius: 50%; }

    .avatar-carousel { display: flex; align-items: center; justify-content: center; gap: 15px; margin: 20px 0; }
    .carousel-btn { width: 30px; height: 30px; border-radius: 50%; background: var(--primary); color: white; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; }

    /* --- GAME & MODALS --- */
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 2000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.3s; backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); }
    .overlay.open { opacity: 1; pointer-events: auto; }
    .modal { background: var(--modal-bg); width: 90%; max-width: 380px; padding: 25px; border-radius: 28px; border: 1px solid var(--border); text-align: center; max-height: 85vh; overflow-y: auto; position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.3); transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
    .overlay.open .modal { transform: scale(1); }

    .timer-bar-bg { width: 100%; height: 6px; background: var(--input-bg); border-radius: 10px; margin: 10px 0; overflow: hidden; }
    .timer-bar-fill { height: 100%; background: var(--accent); width: 100%; transition: width 1s linear; }

    .help-btn { width: 28px; height: 28px; border-radius: 50%; border: 1px solid var(--border); background: var(--card); color: var(--text-muted); display: flex; align-items: center; justify-content: center; font-size: 14px; cursor: pointer; transition:0.2s; }
    .help-btn:active { transform:scale(0.9); }

    /* --- DOCK & FOOTER --- */
    .dock-container { position: fixed; bottom: 20px; left: 0; width: 100%; display: flex; justify-content: center; z-index: 100; pointer-events: none; }
    .dock { background: var(--dock-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); padding: 12px 25px; border-radius: 24px; display: flex; gap: 40px; border: 1px solid var(--border); pointer-events: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.15); }
    .dock i { font-size: 22px; color: var(--text-muted); transition: 0.3s; cursor: pointer; }
    .dock i.active { color: var(--primary); transform: translateY(-5px); }
    
    .device-footer { text-align: center; font-size: 10px; color: var(--text-muted); margin-top: 15px; opacity: 0.6; padding-bottom: 5px; }

    /* --- UTILS --- */
    .hidden { display: none !important; }
    #toastContainer { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 99999; display: flex; flex-direction: column; gap: 8px; width: 90%; max-width: 300px; pointer-events: none; }
    .toast { background: var(--modal-bg); padding: 12px 16px; border-radius: 12px; font-weight: 600; font-size: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); border-left: 4px solid var(--primary); animation: slideDown 0.3s; color: var(--text); border: 1px solid var(--border); }
    @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    
    .custom-input { width: 100%; background: var(--input-bg); border: 1px solid var(--border); padding: 14px; border-radius: 14px; color: var(--text); outline: none; margin-top: 5px; }
  </style>
</head>
<body>

  <audio id="bgMusic_smooth" loop preload="none"><source src="" type="audio/mpeg"></audio>
  <audio id="bgMusic_montagem" loop preload="none"><source src="" type="audio/mpeg"></audio>
  <audio id="bgMusic_sigilo" loop preload="none"><source src="" type="audio/mpeg"></audio>
  <audio id="bgMusic_sempero" loop preload="none"><source src="" type="audio/mpeg"></audio>

  <div id="toastContainer"></div>
  <div class="bg-fx"></div>

  <div class="splash" id="splash">
    <div class="cube-wrap"><div class="cube"><div class="face f1">G</div><div class="face f2">?</div><div class="face f3">!</div><div class="face f4">#</div><div class="face f5"></div><div class="face f6"></div></div></div>
    <h1 style="color:white; letter-spacing:4px; font-weight:800; font-size:32px;">GUESS IT!</h1>
    <div style="color:rgba(255,255,255,0.5); font-size:12px; margin-top:5px;">V1.3.5</div>
  </div>

  <div class="app" id="app">
    <div style="padding: 15px; display: flex; justify-content: space-between; align-items: center;">
        <div style="font-family: var(--font-head); font-weight: 800; font-size: 18px; display: flex; align-items: center; gap: 8px;">
            <i class="fa-solid fa-cube" style="color:var(--primary)"></i> GUESS IT!
        </div>
        <div style="display:flex; gap:5px; align-items:center;">
            <div class="currency-pill"><i class="fa-solid fa-coins" style="color:var(--gold)"></i> <span id="uiCoins">0</span></div>
            <div class="currency-pill"><i class="fa-regular fa-gem" style="color:var(--gem)"></i> <span id="uiGems">0</span></div>
            <div class="currency-pill"><i class="fa-solid fa-bolt" style="color:var(--crystal)"></i> <span id="uiCrystals">0</span></div>
            <div class="help-btn" onclick="openModal('tutHome')" style="margin-left:5px;">?</div>
        </div>
    </div>

    <div class="content">
        <div id="tab-home" class="tab-view">
            <div class="card" style="background: linear-gradient(135deg, #4f46e5, #9333ea); color:white; border:none; position:relative; overflow:hidden;">
                <i class="fa-solid fa-gem" style="position:absolute; right:-10px; bottom:-10px; font-size:80px; opacity:0.1;"></i>
                <div style="position:relative; z-index:2;">
                    <div style="font-size:10px; background:rgba(255,255,255,0.2); width:fit-content; padding:2px 6px; border-radius:4px; margin-bottom:5px;">LIVE EVENT</div>
                    <h3>Crystal Hunt</h3>
                    <div style="font-size:11px; opacity:0.9; margin-bottom:10px;">Play Hardcore. Earn Rank & Crystals!</div>
                    <div class="grid-2">
                        <button class="btn btn-sm" id="eventCheckInBtn" style="background:rgba(255,255,255,0.2); border:none; color:white;" onclick="eventCheckIn()">Check In</button>
                        <button class="btn btn-sm" style="background:white; border:none; color:var(--primary);" onclick="startGame('hardcore')">Hardcore</button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                   <div>
                       <span style="font-size:11px; color:var(--text-muted);">Career Level</span>
                       <div style="font-weight:800; font-size:18px;">Level <span id="homeLvl">1</span></div>
                   </div> 
                   <button class="btn btn-primary" style="width:auto; padding:8px 25px;" onclick="startGame('classic')">
                       <i class="fa-solid fa-play"></i> PLAY
                   </button>
                </div>
                <div style="margin-top:10px; font-size:10px; color:var(--text-muted);">XP Progress</div>
                <div style="width:100%; height:6px; background:var(--input-bg); border-radius:10px; margin-top:5px; overflow:hidden;">
                    <div id="homeXpBar" style="height:100%; background:var(--primary); width:0%; transition:width 0.5s;"></div>
                </div>
                
                <div style="border-top:1px solid var(--border); margin-top:15px; padding-top:10px; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <span style="font-size:11px; color:var(--text-muted);">Hardcore Rank</span>
                        <div style="font-weight:800; font-size:14px; color:var(--accent);" id="homeRankDisplay">Novice</div>
                    </div>
                    <div style="font-size:10px; color:var(--text-muted);">Wins needed: <span id="nextRankReq">5</span></div>
                </div>
            </div>

            <h3 style="margin:20px 0 10px;">Missions</h3>
            <div class="mission-cat-bar">
                <div class="mission-tab active" onclick="setMissionTab('daily', this)">Daily</div>
                <div class="mission-tab" onclick="setMissionTab('event', this)">Event</div>
                <div class="mission-tab" onclick="setMissionTab('lifetime', this)">Lifetime</div>
            </div>
            <div id="missionList"></div>
        </div>

        <div id="tab-shop" class="tab-view hidden">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h2 style="font-family:var(--font-head);">Marketplace</h2>
                <div style="display:flex; gap:5px;">
                    <div class="help-btn" onclick="openModal('currencyGuide')">$</div>
                    <div class="help-btn" onclick="openModal('tutShop')">?</div>
                </div>
            </div>

            <div class="grid-2" style="margin-bottom:15px;">
                <button class="btn" onclick="checkCalendar()"><i class="fa-solid fa-calendar-check" style="color:var(--gold)"></i> Daily</button>
                <button class="btn" onclick="openModal('spinnerModal')"><i class="fa-solid fa-dharmachakra" style="color:var(--accent)"></i> Spinner</button>
            </div>
            
            <div class="card" style="border-color:var(--crystal);">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h4 style="color:var(--crystal)">Event Shop</h4>
                    <div style="font-size:11px;">Bal: <span id="shopCrystalBal">0</span> <i class="fa-solid fa-bolt" style="color:var(--crystal)"></i></div>
                </div>
                <div class="grid-3" id="shopRedeem"></div>
            </div>

            <h4 style="margin:15px 0 10px; color:var(--text-muted); font-size:12px;">POWER UPS</h4>
            <div class="grid-2" id="shopConsumables"></div>
            
            <h4 style="margin:15px 0 10px; color:var(--text-muted); font-size:12px;">COSMETICS</h4>
            <div class="grid-2" id="shopCosmetics"></div>
        </div>

        <div id="tab-profile" class="tab-view hidden">
            <div style="display:flex; justify-content:flex-end;">
                 <div class="help-btn" onclick="openModal('settingsModal')"><i class="fa-solid fa-gear"></i></div>
            </div>
            <div class="card" style="text-align:center; margin-top:10px;">
                <div style="position: relative; display: inline-block; width: 90px; height: 90px;">
                    <div id="profileFrame" style="position:absolute; inset:-5px; border-radius:50%; z-index:2; pointer-events:none;"></div>
                    <img id="profileAvatar" src="" style="width:100%; height:100%; border-radius:50%; border:2px solid var(--border);">
                    <div id="profileBadge" style="position:absolute; bottom:0; right:0; width:24px; height:24px; background:var(--bg); border:1px solid var(--border); border-radius:50%; display:flex; align-items:center; justify-content:center; z-index:3; color:var(--gold);"></div>
                </div>
                <h2 style="margin-top:10px;" id="profileName">Guest</h2>
                <div style="font-size:12px; color:var(--text-muted); margin-bottom:15px;">Level <span id="profileLvl">1</span> â€¢ <span id="profileRank">Novice</span></div>
                
                <div class="grid-2">
                    <button class="btn btn-primary" onclick="openModal('authModal')">Login / Save</button>
                    <button class="btn" onclick="openModal('setupModal')">Edit Profile</button>
                </div>
                <button class="btn" style="margin-top:10px;" onclick="openModal('inventoryModal')">Inventory</button>
            </div>
            
            <div class="card">
                <h4 style="margin-bottom:10px;">Statistics</h4>
                <div style="display:flex; justify-content:space-between; font-size:13px; padding:5px 0; border-bottom:1px solid var(--border);">
                    <span>Classic Wins</span> <span id="statWins">0</span>
                </div>
                <div style="display:flex; justify-content:space-between; font-size:13px; padding:5px 0; border-bottom:1px solid var(--border);">
                    <span>Hardcore Wins</span> <span id="statHardWins">0</span>
                </div>
                <div style="display:flex; justify-content:space-between; font-size:13px; padding:5px 0;">
                    <span>Total XP</span> <span id="statXp">0</span>
                </div>
            </div>

            <div class="device-footer" id="deviceFooter">Running on Unknown Device</div>
        </div>
    </div>

    <div class="dock-container">
        <div class="dock">
            <i class="fa-solid fa-house active" onclick="switchTab('home', this)"></i>
            <i class="fa-solid fa-store" onclick="switchTab('shop', this)"></i>
            <i class="fa-solid fa-user" onclick="switchTab('profile', this)"></i>
        </div>
    </div>
  </div>

  <div class="overlay" id="authModal">
      <div class="modal">
          <h3>Save Progress</h3>
          <p style="font-size:12px; color:var(--text-muted); margin-bottom:20px;">Login to sync your progress across devices.</p>
          <button class="btn" style="background:white; color:black; border:1px solid #ddd; margin-bottom:10px;" onclick="showToast('Google Auth Demo', 'success')"><i class="fa-brands fa-google"></i> Sign in with Google</button>
          <button class="btn" onclick="showToast('Email Auth Demo', 'success')"><i class="fa-solid fa-envelope"></i> Sign in with Email</button>
          <button class="btn" style="margin-top:20px; border:none; background:transparent;" onclick="closeModal('authModal')">Cancel</button>
      </div>
  </div>

  <div class="overlay" id="gameModal">
      <div class="modal">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
              <span id="gameModeBadge" style="font-size:10px; background:var(--accent); color:white; padding:3px 8px; border-radius:6px; font-weight:bold;">HARDCORE</span>
              <i class="fa-solid fa-xmark" onclick="endGame(false)" style="cursor:pointer; font-size:20px; color:var(--text-muted);"></i>
          </div>
          
          <div id="hardcoreTimer" class="timer-bar-bg hidden"><div id="timerFill" class="timer-bar-fill"></div></div>

          <div style="width:180px; height:180px; background:white; border-radius:20px; margin:10px auto; padding:20px; display:flex; align-items:center; justify-content:center; box-shadow:0 10px 30px rgba(0,0,0,0.05);">
              <img id="gameImg" style="width:100%; height:100%; object-fit:contain;">
          </div>
          
          <input type="text" id="gInput" class="custom-input" style="text-align:center; font-size:18px; letter-spacing:1px;" placeholder="LOGO NAME" autocomplete="off">
          
          <div style="display:flex; gap:10px; margin-top:15px;">
              <button class="btn btn-sm" style="flex:1;" onclick="useHint()"><i class="fa-solid fa-lightbulb" style="color:var(--gold)"></i> Hint (<span id="gameHintCount">0</span>)</button>
              <button class="btn btn-primary" style="flex:2;" onclick="submitGuess()">SUBMIT</button>
          </div>
      </div>
  </div>

  <div class="overlay" id="spinnerModal">
      <div class="modal">
          <h3>Lucky Spin</h3>
          <div style="width:200px; height:200px; border-radius:50%; background:conic-gradient(var(--accent) 0deg 60deg, var(--primary) 60deg 120deg, var(--gold) 120deg 180deg, #10b981 180deg 240deg, #a855f7 240deg 300deg, #3b82f6 300deg 360deg); margin:20px auto; border:5px solid var(--card); box-shadow:0 0 20px rgba(0,0,0,0.1); transition:transform 4s cubic-bezier(0.25, 0.1, 0.25, 1);" id="theWheel"></div>
          <div id="spinTimer" style="font-size:12px; color:var(--text-muted); margin-bottom:10px;"></div>
          <button class="btn btn-primary" id="spinBtn" onclick="spinWheel()">SPIN NOW</button>
          
          <div style="margin-top:20px; padding-top:10px; border-top:1px solid var(--border);">
              <div style="font-size:11px; font-weight:bold; color:var(--text-muted); margin-bottom:8px;">POSSIBLE REWARDS</div>
              <div class="grid-3" style="font-size:10px; gap:4px;">
                  <span class="currency-pill" style="justify-content:center; background:var(--card);"><i class="fa-solid fa-coins" style="color:var(--gold)"></i> 100</span>
                  <span class="currency-pill" style="justify-content:center; background:var(--card);"><i class="fa-solid fa-coins" style="color:var(--gold)"></i> 500</span>
                  <span class="currency-pill" style="justify-content:center; background:var(--card);"><i class="fa-solid fa-bolt" style="color:var(--crystal)"></i> 10</span>
                  <span class="currency-pill" style="justify-content:center; background:var(--card);"><i class="fa-regular fa-gem" style="color:var(--gem)"></i> 5</span>
                  <span class="currency-pill" style="justify-content:center; background:var(--card);"><i class="fa-regular fa-gem" style="color:var(--gem)"></i> 20</span>
                  <span class="currency-pill" style="justify-content:center; background:var(--card);">Jackpot</span>
              </div>
          </div>
          <button class="btn btn-sm" style="margin-top:15px; background:transparent; border:none;" onclick="closeModal('spinnerModal')">Close</button>
      </div>
  </div>

  <div class="overlay" id="setupModal">
      <div class="modal">
          <h3>Edit Profile</h3>
          <div class="avatar-carousel">
              <button class="carousel-btn" onclick="changeAvatar(-1)"><i class="fa-solid fa-chevron-left"></i></button>
              <img id="setupAvatarPreview" src="" style="width:80px; height:80px; border-radius:50%; border:2px solid var(--primary);">
              <button class="carousel-btn" onclick="changeAvatar(1)"><i class="fa-solid fa-chevron-right"></i></button>
          </div>
          <div style="font-size:11px; color:var(--text-muted); margin-bottom:15px;">Avatar <span id="avatarIndexDisplay">1</span>/50</div>
          
          <input id="setupName" class="custom-input" placeholder="Username">
          
          <button class="btn btn-primary" style="margin-top:20px;" onclick="saveProfile()">Save Changes</button>
          <button class="btn" style="margin-top:10px;" onclick="closeModal('setupModal')">Cancel</button>
      </div>
  </div>

  <div class="overlay" id="inventoryModal">
      <div class="modal">
          <h3>Your Inventory</h3>
          <div class="mission-cat-bar" style="justify-content:center; margin:15px 0;">
             <div class="mission-tab active" onclick="filterInv('all', this)">All</div>
             <div class="mission-tab" onclick="filterInv('frame', this)">Frames</div>
             <div class="mission-tab" onclick="filterInv('theme', this)">Themes</div>
          </div>
          <div class="grid-3" id="invGrid"></div>
          <button class="btn" style="margin-top:20px;" onclick="closeModal('inventoryModal')">Close</button>
      </div>
  </div>

  <div class="overlay" id="calendarModal">
      <div class="modal">
          <h3>Daily Login</h3>
          <p style="font-size:12px; color:var(--text-muted); margin-bottom:15px;">Login 7 days in a row for big rewards!</p>
          <div class="grid-3" id="calGrid"></div>
          <button class="btn btn-primary" id="claimCalBtn" style="margin-top:20px;" onclick="claimCalendar()">Claim</button>
          <button class="btn" style="margin-top:10px; border:none;" onclick="closeModal('calendarModal')">Close</button>
      </div>
  </div>

  <div class="overlay" id="settingsModal">
      <div class="modal">
          <h3>Settings</h3>
          <div style="text-align:left; margin:15px 0;">
              <label style="font-size:11px; color:var(--text-muted);">Background Music</label>
              <select class="custom-input" id="bgmSelect" onchange="changeBGM(this.value)">
                 <option value="SMOOTH">Smooth</option>
                 <option value="MONTAGEM">Montagem</option>
                 <option value="SIGILO">Sigilo</option>
                 <option value="SEMPERO">Sempero</option>
             </select>
          </div>
          <button class="btn" onclick="toggleSetting('music')">Music: <span id="stMusic">OFF</span></button>
          <button class="btn" style="margin-top:8px;" onclick="toggleDarkMode()">Toggle Dark Mode</button>
          <button class="btn" style="color:#ef4444; border-color:#ef4444; margin-top:8px;" onclick="resetData()">Reset Save Data</button>
          <button class="btn" style="margin-top:10px;" onclick="closeModal('settingsModal')">Close</button>
      </div>
  </div>

  <div class="overlay" id="tutHome"><div class="modal"><h3>How to Play</h3><p style="font-size:13px; color:var(--text-muted); margin:15px 0;"><b>Classic:</b> Win to earn XP and Level Up.<br><b>Hardcore:</b> Win to earn Rank Points and Crystals. 20s time limit!</p><button class="btn" onclick="closeModal('tutHome')">Got it</button></div></div>
  <div class="overlay" id="tutShop"><div class="modal"><h3>Shop Guide</h3><p style="font-size:13px; color:var(--text-muted); margin:15px 0;"><b>Coins:</b> Buy Consumables & Cosmetics.<br><b>Gems:</b> Premium items.<br><b>Crystals:</b> Exclusive Event frames.</p><button class="btn" onclick="closeModal('tutShop')">Got it</button></div></div>
  <div class="overlay" id="currencyGuide"><div class="modal"><h3>Currencies</h3><div style="text-align:left; font-size:13px; display:flex; flex-direction:column; gap:10px; margin:20px 0;"><div style="display:flex;gap:10px;"><i class="fa-solid fa-coins" style="color:var(--gold)"></i> Coins: Earned by playing.</div><div style="display:flex;gap:10px;"><i class="fa-regular fa-gem" style="color:var(--gem)"></i> Gems: Rare drops & Calendar.</div><div style="display:flex;gap:10px;"><i class="fa-solid fa-bolt" style="color:var(--crystal)"></i> Crystals: Hardcore wins & Events.</div></div><button class="btn" onclick="closeModal('currencyGuide')">Close</button></div></div>

  <script>
    // --- SAFE INIT ---
    window.addEventListener('DOMContentLoaded', () => {
        try { loadData(); } catch(e) { console.error("Load failed, resetting", e); resetData(); }
        setTimeout(() => removeSplash(), 3000);
        document.body.addEventListener('click', () => {
            if(!audioCtx && state.settings.music) {
                try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e){}
            }
        }, {once:true});
        detectDevice();
    });

    window.onload = () => { removeSplash(); };

    function removeSplash() {
        const splash = document.getElementById('splash');
        if(splash && !splash.classList.contains('hidden')) {
            splash.classList.add('hidden');
            document.getElementById('app').classList.add('loaded');
            renderAll();
        }
    }

    function detectDevice() {
        const ua = navigator.userAgent;
        let device = "Desktop Browser";
        if(/Android/i.test(ua)) device = "Android Device";
        else if(/iPhone|iPad|iPod/i.test(ua)) device = "Apple Device";
        else if(/Windows/i.test(ua)) device = "Windows PC";
        else if(/Mac/i.test(ua)) device = "Mac OS";
        document.getElementById('deviceFooter').innerText = "Running on " + device;
    }

    // --- DATA ---
    const AVATARS = [
        'Felix','Aneka','Zack','Midnight','Luna','Jack','Leo','Bella','Shadow','Pixel','Rocky','Ginger','Tiger','Bear','Fox','Wolf','Socks','Simba','Misty','Bandit',
        'Abby','Zoey','Buster','Buddy','Coco','Lola','Max','Milo','Charlie','Cooper','Duke','Riley','Sam','Scout','Teddy','Toby','Tucker','Ziggy','Daisy','Lily',
        'Gizmo','Kiki','Loki','Moose','Nala','Oliver','Oscar','Piper','Rex','Rosie'
    ]; 
    
    const RANKS = [
        {n:'Novice', w:0}, {n:'Rookie', w:5}, {n:'Pro', w:15}, 
        {n:'Elite', w:30}, {n:'Master', w:50}, {n:'Legend', w:100}
    ];

    // EXPANDED LOGOS LIST
    const LOGOS = [
        // Tech
        {n:'Apple',d:'apple.com'}, {n:'Google',d:'google.com'}, {n:'Microsoft',d:'microsoft.com'}, 
        {n:'Amazon',d:'amazon.com'}, {n:'Netflix',d:'netflix.com'}, {n:'Spotify',d:'spotify.com'},
        {n:'Facebook',d:'facebook.com'}, {n:'Instagram',d:'instagram.com'}, {n:'Twitter',d:'twitter.com'},
        {n:'Tiktok',d:'tiktok.com'}, {n:'YouTube',d:'youtube.com'}, {n:'Discord',d:'discord.com'},
        {n:'Samsung',d:'samsung.com'}, {n:'Intel',d:'intel.com'}, {n:'IBM',d:'ibm.com'},
        
        // Food & Drink
        {n:'McDonalds',d:'mcdonalds.com'}, {n:'Burger King',d:'burgerking.com'}, {n:'KFC',d:'kfc.com'},
        {n:'Starbucks',d:'starbucks.com'}, {n:'Pepsi',d:'pepsi.com'}, {n:'Coca Cola',d:'coca-cola.com'},
        {n:'Red Bull',d:'redbull.com'}, {n:'Dominos',d:'dominos.com'}, {n:'Pizza Hut',d:'pizzahut.com'},
        
        // Auto
        {n:'Tesla',d:'tesla.com'}, {n:'BMW',d:'bmw.com'}, {n:'Mercedes',d:'mercedes-benz.com'},
        {n:'Audi',d:'audi.com'}, {n:'Toyota',d:'toyota.com'}, {n:'Honda',d:'honda.com'},
        {n:'Ford',d:'ford.com'}, {n:'Ferrari',d:'ferrari.com'}, {n:'Porsche',d:'porsche.com'},
        
        // Fashion
        {n:'Nike',d:'nike.com'}, {n:'Adidas',d:'adidas.com'}, {n:'Puma',d:'puma.com'},
        {n:'Gucci',d:'gucci.com'}, {n:'Louis Vuitton',d:'louisvuitton.com'}, {n:'Zara',d:'zara.com'},
        {n:'Chanel',d:'chanel.com'}, {n:'H&M',d:'hm.com'}
    ];

    const ITEMS = [
        { id:'hint', n:'Hint Token', type:'consumable', cost:50, curr:'coins', icon:'fa-lightbulb' },
        { id:'xp_boost', n:'XP Boost', type:'consumable', cost:100, curr:'coins', icon:'fa-arrow-up' },
        { id:'frame_neon', n:'Neon', type:'frame', cost:50, curr:'crystals', css:'border:3px solid #0ff; box-shadow:0 0 10px #0ff;' },
        { id:'frame_gold', n:'Gold Halo', type:'frame', cost:100, curr:'crystals', css:'border:3px solid #f59e0b; box-shadow:0 0 15px #f59e0b;' },
        { id:'frame_ruby', n:'Ruby', type:'frame', cost:150, curr:'crystals', css:'border:3px solid #f43f5e; box-shadow:0 0 15px #f43f5e;' },
        { id:'frame_cyber', n:'Cyber', type:'frame', cost:200, curr:'crystals', css:'border:3px dashed #10b981; box-shadow:0 0 15px #10b981;' },
        { id:'th_gold', n:'Gold', type:'theme', cost:500, curr:'coins', val:'Gold' },
        { id:'th_matrix', n:'Matrix', type:'theme', cost:500, curr:'coins', val:'Matrix' }
    ];

    const MISSIONS = [
        { id:'d1', type:'daily', desc:'Play 5 Games', target:5, rwd:50, curr:'coins' },
        { id:'d2', type:'daily', desc:'Win 3 Hardcore', target:3, rwd:100, curr:'coins' },
        { id:'e1', type:'event', desc:'Earn 20 Crystals', target:20, rwd:5, curr:'gems' },
        { id:'l1', type:'lifetime', desc:'Reach Level 5', target:5, rwd:500, curr:'coins' },
        { id:'l2', type:'lifetime', desc:'Win 100 Games', target:100, rwd:20, curr:'gems' }
    ];

    // --- STATE ---
    let state = {
        user: { name:'Guest', avatarIdx:0, frame:null, theme:'' },
        wallet: { coins:100, gems:5, crystals:0 },
        stats: { lvl:1, xp:0, wins:0, gamesPlayed:0, hardcoreWins:0 },
        inv: {}, 
        missionProg: {}, 
        daily: { lastLogin:'', streak:0, lastSpin:0, lastEvent:'' },
        settings: { music:false, bgm:'SMOOTH', darkMode:false },
        claimedMissions: []
    };
    
    let currentGame = null;
    let gameMode = 'classic';
    let gameTimerInt = null;
    let tempAvatarIdx = 0;
    let currentMissionTab = 'daily';
    let audioCtx = null;
    let currentAudio = null;

    // --- AUDIO ---
    function updateAudioState() {
        if(!audioCtx) { try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e){} }
        
        ['smooth','montagem','sigilo','sempero'].forEach(k=> {
            const el = document.getElementById('bgMusic_'+k);
            if(el) el.pause();
        });
        
        const map = {'SMOOTH':'smooth','MONTAGEM':'montagem','SIGILO':'sigilo','SEMPERO':'sempero'};
        const target = document.getElementById('bgMusic_'+map[state.settings.bgm]);
        
        if(state.settings.music && target) { 
            if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
            target.play().catch(e => console.log("Audio play failed (interaction needed)", e));
        }
        document.getElementById('stMusic').innerText = state.settings.music ? 'ON' : 'OFF';
    }
    
    function toggleSetting(k) { 
        if(k==='music') {
            state.settings.music = !state.settings.music;
            updateAudioState();
        }
        saveData(); 
    }
    function changeBGM(v) { state.settings.bgm=v; updateAudioState(); saveData(); }

    // --- GAME LOGIC ---
    function startGame(mode) {
        gameMode = mode;
        currentGame = LOGOS[Math.floor(Math.random() * LOGOS.length)];
        
        document.getElementById('gameImg').src = `https://logo.clearbit.com/${currentGame.d}`;
        document.getElementById('gInput').value = '';
        document.getElementById('gameModeBadge').className = mode === 'hardcore' ? '' : 'hidden';
        document.getElementById('hardcoreTimer').className = mode === 'hardcore' ? 'timer-bar-bg' : 'hidden';
        document.getElementById('gameHintCount').innerText = state.inv['hint'] || 0;
        
        openModal('gameModal');

        if(mode === 'hardcore') {
            document.getElementById('timerFill').style.width = '100%';
            let timeLeft = 20;
            setTimeout(() => document.getElementById('timerFill').style.width = '0%', 100);
            
            clearInterval(gameTimerInt);
            gameTimerInt = setInterval(() => {
                timeLeft--;
                if(timeLeft <= 0) {
                    endGame(false);
                    showToast("Time's Up!", "error");
                }
            }, 1000);
        }
    }

    function submitGuess() {
        const guess = document.getElementById('gInput').value.trim().toLowerCase().replace(/[^a-z0-9]/g, ''); // Basic normalize
        const target = currentGame.n.toLowerCase().replace(/[^a-z0-9]/g, '');

        if(guess === target) {
            let xp = 0, coins = 0, crystals = 0;

            if(gameMode === 'classic') {
                xp = 100; coins = 50;
                state.stats.wins++;
                addXp(xp);
            } else {
                xp = 20; coins = 100; crystals = 10;
                state.stats.hardcoreWins++;
                state.wallet.crystals += crystals;
                showToast(`+${crystals} Crystals!`, "success");
            }
            
            state.wallet.coins += coins;
            state.stats.gamesPlayed++;
            
            updateMissionProg('play', 1);
            if(gameMode === 'hardcore') updateMissionProg('win_hard', 1);

            showToast(`Correct! +${coins} Coins`, "success");
            endGame(true);
        } else {
            showToast("Wrong! Try again.", "error");
            const inp = document.getElementById('gInput');
            inp.style.borderColor = '#ef4444';
            setTimeout(()=> inp.style.borderColor = 'var(--border)', 500);
        }
    }

    function useHint() {
        if((state.inv['hint'] || 0) > 0) {
            state.inv['hint']--;
            document.getElementById('gInput').value = currentGame.n.substring(0, 2); 
            document.getElementById('gameHintCount').innerText = state.inv['hint'];
            showToast("Hint Used!", "success");
            saveData();
        } else {
            showToast("No Hint Tokens!", "error");
        }
    }

    function endGame(win) {
        clearInterval(gameTimerInt);
        closeModal('gameModal');
        saveData();
        renderAll();
    }

    function addXp(amount) {
        state.stats.xp += amount;
        let req = state.stats.lvl * 100;
        if(state.stats.xp >= req) {
            state.stats.xp -= req;
            state.stats.lvl++;
            showToast(`LEVEL UP! You are now Lvl ${state.stats.lvl}`, "success");
            if(state.stats.lvl >= 5) updateMissionProg('lvl5', 5);
        }
    }

    function getRankName() {
        let rName = "Novice";
        for(let r of RANKS) { if(state.stats.hardcoreWins >= r.w) rName = r.n; }
        return rName;
    }
    
    function getNextRankReq() {
        for(let r of RANKS) { if(state.stats.hardcoreWins < r.w) return r.w; }
        return "MAX";
    }

    // --- MISSIONS ---
    function updateMissionProg(type, val) {
        MISSIONS.forEach(m => {
            if(m.id === 'd1' && type === 'play') state.missionProg[m.id] = (state.missionProg[m.id]||0) + val;
            if(m.id === 'd2' && type === 'win_hard') state.missionProg[m.id] = (state.missionProg[m.id]||0) + val;
            if(m.id === 'l1' && type === 'lvl5') state.missionProg[m.id] = 5;
            if(m.id === 'l2' && type === 'play') state.missionProg[m.id] = state.stats.wins + state.stats.hardcoreWins;
        });
    }

    function claimMission(id) {
        let m = MISSIONS.find(x => x.id === id);
        if(!state.claimedMissions.includes(id)) {
            state.wallet[m.curr] += m.rwd;
            state.claimedMissions.push(id);
            showToast(`Claimed ${m.rwd} ${m.curr}!`, "success");
            saveData();
            renderMissions();
            renderHeader();
        }
    }

    function setMissionTab(type, el) {
        currentMissionTab = type;
        document.querySelectorAll('.mission-tab').forEach(t => t.classList.remove('active'));
        el.classList.add('active');
        renderMissions();
    }

    function renderMissions() {
        const div = document.getElementById('missionList');
        div.innerHTML = '';
        
        MISSIONS.filter(m => m.type === currentMissionTab).forEach(m => {
            let prog = state.missionProg[m.id] || 0;
            if(m.id === 'l1') prog = state.stats.lvl;
            if(m.id === 'l2') prog = state.stats.wins + state.stats.hardcoreWins;

            let isDone = prog >= m.target;
            let isClaimed = state.claimedMissions.includes(m.id);
            
            div.innerHTML += `
            <div style="background:var(--card); padding:10px; border-radius:12px; border:1px solid var(--border); margin-bottom:8px; display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <div style="font-weight:bold; font-size:12px;">${m.desc}</div>
                    <div style="font-size:10px; color:var(--text-muted);">Reward: ${m.rwd} ${m.curr}</div>
                </div>
                <div>
                    ${isClaimed 
                        ? '<i class="fa-solid fa-check" style="color:#10b981"></i>' 
                        : isDone 
                            ? `<button class="btn btn-primary btn-sm" onclick="claimMission('${m.id}')">Claim</button>` 
                            : `<div style="font-size:10px; font-weight:bold; color:var(--text-muted);">${prog}/${m.target}</div>`
                    }
                </div>
            </div>`;
        });
    }

    // --- SHOP & INVENTORY ---
    function buyItem(id) {
        let item = ITEMS.find(x => x.id === id);
        if(state.wallet[item.curr] >= item.cost) {
            state.wallet[item.curr] -= item.cost;
            state.inv[id] = (state.inv[id] || 0) + 1;
            showToast("Purchased!", "success");
            saveData();
            renderAll();
        } else {
            showToast("Not enough funds", "error");
        }
    }

    function equipItem(id, type) {
        if(type === 'frame') state.user.frame = id;
        if(type === 'theme') {
            state.user.theme = ITEMS.find(x=>x.id===id).val;
            document.body.setAttribute('data-theme', state.user.theme);
        }
        showToast("Equipped!", "success");
        saveData();
        renderAll();
    }

    function renderShop() {
        const redeem = document.getElementById('shopRedeem');
        const cons = document.getElementById('shopConsumables');
        const cosm = document.getElementById('shopCosmetics');
        
        [redeem, cons, cosm].forEach(e => e.innerHTML='');
        document.getElementById('shopCrystalBal').innerText = state.wallet.crystals;

        ITEMS.forEach(i => {
            let icon = i.curr === 'coins' ? 'fa-coins' : i.curr === 'gems' ? 'fa-gem' : 'fa-bolt';
            let color = i.curr === 'coins' ? 'var(--gold)' : i.curr === 'gems' ? 'var(--gem)' : 'var(--crystal)';
            
            let html = `
            <div class="item-box" onclick="buyItem('${i.id}')">
                ${state.inv[i.id] ? '<div class="tag-owned"></div>' : ''}
                <div style="height:40px; display:flex; align-items:center; justify-content:center;">
                   ${i.type === 'frame' ? `<div style="width:30px; height:30px; border-radius:50%; ${i.css}"></div>` : `<i class="fa-solid ${i.icon||'fa-star'}" style="font-size:24px; color:var(--text-muted)"></i>`}
                </div>
                <div style="font-size:11px; font-weight:700;">${i.n}</div>
                <div class="item-price" style="color:${color}">
                    <i class="fa-solid ${icon}"></i> ${i.cost}
                </div>
            </div>`;

            if(i.curr === 'crystals') redeem.innerHTML += html;
            else if(i.type === 'consumable') cons.innerHTML += html;
            else cosm.innerHTML += html;
        });
    }

    // --- EVENTS & DAILY ---
    function eventCheckIn() {
        const today = new Date().toDateString();
        if(state.daily.lastEvent !== today) {
            state.daily.lastEvent = today;
            state.wallet.crystals += 5;
            showToast("+5 Crystals Checked In!", "success");
            saveData();
            renderAll();
        } else {
            showToast("Already claimed today!", "error");
        }
    }

    function spinWheel() {
        const now = Date.now();
        if(now - state.daily.lastSpin > 3600000) { 
            state.daily.lastSpin = now;
            document.getElementById('theWheel').style.transform = `rotate(${1000 + Math.random()*1000}deg)`;
            
            setTimeout(() => {
                let r = Math.random();
                let reward = r > 0.9 ? {t:'gems',v:10} : r > 0.7 ? {t:'crystals',v:5} : {t:'coins',v:100};
                state.wallet[reward.t] += reward.v;
                showToast(`You won ${reward.v} ${reward.t}!`, "success");
                saveData();
                renderAll();
                closeModal('spinnerModal');
            }, 4000);
        } else {
            showToast("Cooldown active!", "error");
        }
    }

    function updateSpinTimer() {
        const now = Date.now();
        const diff = 3600000 - (now - state.daily.lastSpin);
        if(diff > 0) {
            let m = Math.floor(diff/60000);
            let s = Math.floor((diff%60000)/1000);
            document.getElementById('spinTimer').innerText = `Next spin in: ${m}m ${s}s`;
            document.getElementById('spinBtn').disabled = true;
            document.getElementById('spinBtn').style.opacity = 0.5;
        } else {
            document.getElementById('spinTimer').innerText = "Ready to Spin!";
            document.getElementById('spinBtn').disabled = false;
            document.getElementById('spinBtn').style.opacity = 1;
        }
    }
    setInterval(updateSpinTimer, 1000);

    // --- PROFILE & SETTINGS ---
    function changeAvatar(dir) {
        tempAvatarIdx += dir;
        if(tempAvatarIdx < 0) tempAvatarIdx = AVATARS.length - 1;
        if(tempAvatarIdx >= AVATARS.length) tempAvatarIdx = 0;
        document.getElementById('setupAvatarPreview').src = `https://api.dicebear.com/9.x/adventurer/svg?seed=${AVATARS[tempAvatarIdx]}`;
        document.getElementById('avatarIndexDisplay').innerText = tempAvatarIdx + 1;
    }

    function saveProfile() {
        state.user.avatarIdx = tempAvatarIdx;
        let n = document.getElementById('setupName').value;
        if(n.trim()) state.user.name = n;
        saveData();
        closeModal('setupModal');
        renderAll();
        showToast("Profile Updated", "success");
    }

    // --- RENDER MASTER ---
    function renderAll() {
        renderHeader();
        renderHome();
        renderShop();
        renderMissions();
        renderProfile();
        
        tempAvatarIdx = state.user.avatarIdx;
        document.getElementById('setupAvatarPreview').src = `https://api.dicebear.com/9.x/adventurer/svg?seed=${AVATARS[state.user.avatarIdx]}`;
    }

    function renderHeader() {
        document.getElementById('uiCoins').innerText = state.wallet.coins;
        document.getElementById('uiGems').innerText = state.wallet.gems;
        document.getElementById('uiCrystals').innerText = state.wallet.crystals;
    }

    function renderHome() {
        document.getElementById('homeLvl').innerText = state.stats.lvl;
        document.getElementById('homeXpBar').style.width = Math.min((state.stats.xp/(state.stats.lvl*100))*100, 100) + '%';
        document.getElementById('homeRankDisplay').innerText = getRankName();
        document.getElementById('nextRankReq').innerText = getNextRankReq();

        const today = new Date().toDateString();
        document.getElementById('eventCheckInBtn').style.opacity = state.daily.lastEvent === today ? 0.5 : 1;
        document.getElementById('eventCheckInBtn').innerText = state.daily.lastEvent === today ? "Claimed" : "Check In";
    }

    function renderProfile() {
        document.getElementById('profileName').innerText = state.user.name;
        document.getElementById('profileAvatar').src = `https://api.dicebear.com/9.x/adventurer/svg?seed=${AVATARS[state.user.avatarIdx]}`;
        
        const frameDiv = document.getElementById('profileFrame');
        if(state.user.frame) {
            let f = ITEMS.find(x=>x.id===state.user.frame);
            if(f) frameDiv.style.cssText = `position:absolute; inset:-5px; border-radius:50%; z-index:2; pointer-events:none; ${f.css}`;
        } else {
            frameDiv.style.cssText = '';
        }
        
        document.getElementById('profileLvl').innerText = state.stats.lvl;
        document.getElementById('profileRank').innerText = getRankName();
        document.getElementById('statWins').innerText = state.stats.wins;
        document.getElementById('statHardWins').innerText = state.stats.hardcoreWins;
        document.getElementById('statXp').innerText = state.stats.xp;
        
        const invGrid = document.getElementById('invGrid');
        invGrid.innerHTML = '';
        Object.keys(state.inv).forEach(k => {
            if(state.inv[k] > 0) {
                let i = ITEMS.find(x=>x.id===k);
                if(i && (i.type === 'frame' || i.type === 'theme')) {
                    invGrid.innerHTML += `<div class="item-box" onclick="equipItem('${k}','${i.type}')">${i.n}</div>`;
                }
            }
        });
    }

    // --- SYSTEM UTILS ---
    function switchTab(id, el) {
        document.querySelectorAll('.tab-view').forEach(t => t.classList.add('hidden'));
        document.getElementById('tab-'+id).classList.remove('hidden');
        document.querySelectorAll('.dock i').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
    }

    function openModal(id) { document.getElementById(id).classList.add('open'); }
    function closeModal(id) { document.getElementById(id).classList.remove('open'); }
    
    function showToast(msg, type) {
        const t = document.createElement('div');
        t.className = `toast`;
        if(type==='error') t.style.borderLeftColor = '#ef4444';
        t.innerText = msg;
        document.getElementById('toastContainer').appendChild(t);
        setTimeout(() => t.remove(), 2500);
    }

    function saveData() { 
        try { localStorage.setItem('guessit_v135', JSON.stringify(state)); } catch(e){ console.error("Save failed", e); }
    }
    
    function loadData() {
        try {
            const d = localStorage.getItem('guessit_v135');
            if(d) state = {...state, ...JSON.parse(d)};
            if(state.user.theme) document.body.setAttribute('data-theme', state.user.theme);
            if(state.settings.darkMode) document.body.classList.add('dark-mode');
        } catch(e) {
            console.error("Data corrupted, resetting.");
            resetData();
        }
    }
    
    function resetData() { 
        localStorage.removeItem('guessit_v135'); 
        window.location.reload(); 
    }
    
    function toggleDarkMode() {
        document.body.classList.toggle('dark-mode');
        state.settings.darkMode = document.body.classList.contains('dark-mode');
        saveData();
    }
    
    function checkCalendar() { openModal('calendarModal'); }
    function claimCalendar() { showToast("Coming Soon", "error"); }
    function filterInv(type, el) { 
        document.querySelectorAll('#inventoryModal .mission-tab').forEach(t=>t.classList.remove('active'));
        el.classList.add('active');
    }
  </script>
</body>
</html>
