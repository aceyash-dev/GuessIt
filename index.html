<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="theme-color" content="#0f172a">
  <title>Guess It! V1.3.2-R</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Space+Grotesk:wght@300;500;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    /* --- VARIABLES --- */
    :root {
      --bg: #f8fafc; --card: rgba(255, 255, 255, 0.95); --border: rgba(99, 102, 241, 0.15);
      --text: #0f172a; --text-muted: #64748b; --primary: #4f46e5; --primary-glow: rgba(79, 70, 229, 0.2);
      --accent: #f43f5e; --gold: #f59e0b; --crystal: #8b5cf6; --gem: #0ea5e9;
      --font-head: 'Space Grotesk', sans-serif; --font-body: 'Outfit', sans-serif;
      --modal-bg: #ffffff; --input-bg: #f1f5f9; --dock-bg: rgba(255, 255, 255, 0.98);
    }
    body.dark-mode {
      --bg: #020617; --card: rgba(30, 41, 59, 0.95); --border: rgba(99, 102, 241, 0.3);
      --text: #f8fafc; --text-muted: #94a3b8; --input-bg: rgba(255, 255, 255, 0.05);
      --modal-bg: #0f172a; --dock-bg: rgba(15, 23, 42, 0.98);
    }
    body[data-theme="Gold"] { --bg: #281c04; --card: rgba(60, 40, 10, 0.95); --primary: #d97706; --border: #fcd34d; }
    
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: var(--font-body); user-select: none; -webkit-tap-highlight-color: transparent; }
    body { background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; font-size: 14px; transition: background 0.3s, color 0.3s; position: relative; }

    .bg-fx { position: fixed; inset: 0; z-index: -1; background: radial-gradient(circle at 50% 0%, var(--primary-glow) 0%, transparent 70%); opacity: 0.8; pointer-events: none; }
    
    /* RGB SPLASH */
    .splash { position: fixed; inset: 0; z-index: 9999; background: linear-gradient(125deg, #020617, #2e1065, #4c0519, #020617); background-size: 400% 400%; animation: rgbGlow 10s ease infinite; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s ease-out, visibility 0.5s; }
    .splash.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
    @keyframes rgbGlow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

    .cube-wrap { perspective: 800px; width: 60px; height: 60px; margin-bottom: 30px; }
    .cube { width: 100%; height: 100%; transform-style: preserve-3d; animation: spin 6s infinite linear; }
    .face { position: absolute; width: 60px; height: 60px; background: rgba(255,255,255,0.1); border: 2px solid white; display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; box-shadow: 0 0 20px rgba(255,255,255,0.5); font-weight: 900; backface-visibility: visible; }
    .f1 { transform: translateZ(30px); } .f2 { transform: rotateY(180deg) translateZ(30px); } .f3 { transform: rotateY(90deg) translateZ(30px); } .f4 { transform: rotateY(-90deg) translateZ(30px); } .f5 { transform: rotateX(90deg) translateZ(30px); } .f6 { transform: rotateX(-90deg) translateZ(30px); }
    @keyframes spin { 0% { transform: rotateX(0) rotateY(0); } 100% { transform: rotateX(360deg) rotateY(360deg); } }

    /* LAYOUT */
    .app { max-width: 480px; margin: 0 auto; height: 100%; display: flex; flex-direction: column; opacity: 0; transition: opacity 0.5s; }
    .app.loaded { opacity: 1; }
    .content { flex: 1; overflow-y: auto; padding: 15px 15px 120px 15px; scroll-behavior: smooth; }
    .content::-webkit-scrollbar { display: none; }

    /* COMPONENTS */
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 20px; padding: 18px; margin-bottom: 12px; backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); box-shadow: 0 4px 20px -5px rgba(0,0,0,0.05); }
    .btn { background: var(--input-bg); color: var(--text); border: 1px solid var(--border); padding: 12px; border-radius: 14px; font-weight: 700; cursor: pointer; width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; font-family: var(--font-head); font-size: 13px; text-transform: uppercase; transition: transform 0.1s, background 0.2s; }
    .btn:active { transform: scale(0.97); }
    .btn-primary { background: var(--primary); border-color: var(--primary); color: white; box-shadow: 0 4px 15px var(--primary-glow); }
    .btn-sm { padding: 6px 12px; font-size: 11px; width: auto; }
    
    .currency-pill { background: var(--input-bg); border: 1px solid var(--border); padding: 4px 10px; border-radius: 20px; font-size: 11px; display: flex; align-items: center; gap: 5px; font-weight: 700; }
    .mission-cat-bar { display: flex; gap: 5px; margin-bottom: 10px; overflow-x: auto; padding-bottom: 5px; }
    .mission-tab { padding: 6px 12px; border-radius: 20px; background: var(--input-bg); color: var(--text-muted); font-size: 11px; font-weight: bold; cursor: pointer; border: 1px solid transparent; white-space: nowrap; transition: 0.2s; }
    .mission-tab.active { background: var(--primary); color: white; }

    /* GRID & ITEMS */
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
    .item-box { background: var(--input-bg); border: 1px solid var(--border); padding: 10px; border-radius: 16px; text-align: center; cursor: pointer; position: relative; transition: 0.2s; display:flex; flex-direction:column; align-items:center; justify-content:center; }
    .item-box:active { transform: scale(0.95); }
    .item-price { font-size: 11px; display: flex; align-items: center; justify-content: center; gap: 4px; margin-top: 5px; font-weight: 700; color:var(--text); }
    .tag-owned { position: absolute; top: 5px; right: 5px; width: 8px; height: 8px; background: #10b981; border-radius: 50%; box-shadow: 0 0 5px #10b981; }
    .online-badge { position: absolute; bottom: 2px; right: 2px; width: 14px; height: 14px; background: #10b981; border: 2px solid var(--card); border-radius: 50%; z-index: 10; box-shadow: 0 0 8px rgba(16,185,129,0.5); }

    .avatar-carousel { display: flex; align-items: center; justify-content: center; gap: 15px; margin: 20px 0; }
    .carousel-btn { width: 30px; height: 30px; border-radius: 50%; background: var(--primary); color: white; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; }

    /* MODALS & TABS */
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 2000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.3s; backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); }
    .overlay.open { opacity: 1; pointer-events: auto; }
    .modal { background: var(--modal-bg); width: 90%; max-width: 380px; padding: 25px; border-radius: 28px; border: 1px solid var(--border); text-align: center; max-height: 85vh; overflow-y: auto; position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.3); transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
    .overlay.open .modal { transform: scale(1); }
    
    /* FULL SCREEN GAME MODAL */
    .game-fullscreen { width: 100% !important; height: 100% !important; max-width: none !important; max-height: none !important; border-radius: 0 !important; display: flex; flex-direction: column; justify-content: center; padding-bottom: 80px !important; }

    .tab-nav { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 20px; }
    .tab-btn { flex: 1; padding: 10px; font-size: 12px; font-weight: 700; color: var(--text-muted); cursor: pointer; border-bottom: 2px solid transparent; }
    .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    .timer-bar-bg { width: 100%; height: 6px; background: var(--input-bg); border-radius: 10px; margin: 10px 0; overflow: hidden; }
    .timer-bar-fill { height: 100%; background: var(--accent); width: 100%; transition: width 1s linear; }
    .help-btn { width: 32px; height: 32px; border-radius: 50%; border: 1px solid var(--border); background: var(--card); color: var(--text-muted); display: flex; align-items: center; justify-content: center; font-size: 14px; cursor: pointer; transition:0.2s; }

    /* LEADERBOARD & CALENDAR */
    .leader-row { display: flex; align-items: center; justify-content: space-between; padding: 12px; background: var(--input-bg); border-radius: 14px; margin-bottom: 8px; border: 1px solid var(--border); }
    .leader-row:nth-child(1) { border-color: var(--gold); background: rgba(245, 158, 11, 0.1); }
    .leader-rank { font-weight: 800; width: 25px; color: var(--text-muted); }
    .leader-info { flex: 1; display: flex; align-items: center; gap: 10px; text-align: left; }
    .leader-avatar { width: 32px; height: 32px; border-radius: 50%; border: 1px solid var(--border); background: white; }
    .leader-score { font-weight: 700; color: var(--primary); }

    .cal-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 15px; }
    .cal-day { background: var(--input-bg); padding: 15px 5px; border-radius: 16px; font-size: 10px; border:1px solid var(--border); position: relative; transition: 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px; }
    .cal-day.active { background: var(--primary); color: white; border-color:var(--primary); box-shadow:0 4px 15px var(--primary-glow); transform: scale(1.05); z-index: 2; }
    .cal-day.claimed { opacity: 0.5; background: var(--card); filter: grayscale(1); }
    .cal-day i { font-size: 16px; margin-bottom: 2px; }

    /* DOCK */
    .dock-container { position: fixed; bottom: 20px; left: 0; width: 100%; display: flex; justify-content: center; z-index: 100; pointer-events: none; }
    .dock { background: var(--dock-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); padding: 12px 25px; border-radius: 24px; display: flex; gap: 25px; border: 1px solid var(--border); pointer-events: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.15); }
    .dock i { font-size: 20px; color: var(--text-muted); transition: 0.3s; cursor: pointer; width:40px; text-align:center; }
    .dock i.active { color: var(--primary); transform: translateY(-5px); font-size:22px; }
    .device-footer { text-align: center; font-size: 10px; color: var(--text-muted); margin-top: 15px; opacity: 0.6; padding-bottom: 5px; }

    /* UTILS */
    .hidden { display: none !important; }
    #toastContainer { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 99999; display: flex; flex-direction: column; gap: 8px; width: 90%; max-width: 300px; pointer-events: none; }
    .toast { background: var(--modal-bg); padding: 12px 16px; border-radius: 12px; font-weight: 600; font-size: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); border-left: 4px solid var(--primary); animation: slideDown 0.3s; color: var(--text); border: 1px solid var(--border); }
    @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .custom-input { width: 100%; background: var(--input-bg); border: 1px solid var(--border); padding: 14px; border-radius: 14px; color: var(--text); outline: none; margin-top: 5px; }
    .custom-textarea { width: 100%; background: var(--input-bg); border: 1px solid var(--border); padding: 14px; border-radius: 14px; color: var(--text); outline: none; margin-top: 5px; resize: none; height: 80px; font-family: var(--font-body); }
  </style>
</head>
<body>

  <!-- AUDIO TRACKS -->
  <audio id="bgMusic_1" loop preload="none"><source src="http://googleusercontent.com/file_content/0" type="audio/mpeg"></audio>
  <audio id="bgMusic_2" loop preload="none"><source src="http://googleusercontent.com/file_content/1" type="audio/mpeg"></audio>
  <audio id="bgMusic_3" loop preload="none"><source src="http://googleusercontent.com/file_content/2" type="audio/mpeg"></audio>

  <div id="toastContainer"></div>
  <div class="bg-fx"></div>

  <!-- SPLASH -->
  <div class="splash" id="splash">
    <div class="cube-wrap"><div class="cube"><div class="face f1">G</div><div class="face f2">?</div><div class="face f3">!</div><div class="face f4">#</div><div class="face f5"></div><div class="face f6"></div></div></div>
    <h1 style="color:white; letter-spacing:4px; font-weight:800; font-size:32px;">GUESS IT!</h1>
    <div style="color:rgba(255,255,255,0.5); font-size:12px; margin-top:5px;">V1.3.2-R</div>
  </div>

  <!-- QUICK SETUP WIZARD -->
  <div class="wizard hidden" id="setupWizard" style="position:fixed; inset:0; background:var(--bg); z-index:3000; display:flex; flex-direction:column; padding:30px; align-items:center; justify-content:center; transition:0.3s;">
      <div style="max-width:320px; width:100%; text-align:center;">
          <h2 style="font-family:var(--font-head); font-size:28px; margin-bottom:10px;">Welcome!</h2>
          <p style="color:var(--text-muted); margin-bottom:30px;">Let's get your profile ready.</p>
          <div style="width:100px; height:100px; margin:0 auto 20px; border-radius:50%; background:var(--input-bg); border:2px solid var(--primary); overflow:hidden;">
              <img id="wizAvatar" src="" style="width:100%; height:100%;">
          </div>
          <button class="btn btn-sm" onclick="randomWizAvatar()" style="margin:0 auto 20px; width:auto;"><i class="fa-solid fa-shuffle"></i> Randomize</button>
          <input id="wizName" class="custom-input" placeholder="Enter Username" style="text-align:center;">
          <button class="btn btn-primary" style="margin-top:20px;" onclick="finishWizard(true)">Looks Good!</button>
          <button class="btn" style="margin-top:15px; background:transparent; border:none; color:var(--text-muted);" onclick="finishWizard(false)">Skip</button>
      </div>
  </div>

  <div class="app" id="app">
    <div style="padding: 15px; display: flex; justify-content: space-between; align-items: center;">
        <div style="font-family: var(--font-head); font-weight: 800; font-size: 18px; display: flex; align-items: center; gap: 8px;">
            <i class="fa-solid fa-cube" style="color:var(--primary)"></i> GUESS IT!
        </div>
        <div style="display:flex; gap:5px; align-items:center;">
            <div class="currency-pill"><i class="fa-solid fa-coins" style="color:var(--gold)"></i> <span id="uiCoins">0</span></div>
            <div class="currency-pill"><i class="fa-regular fa-gem" style="color:var(--gem)"></i> <span id="uiGems">0</span></div>
            <div class="currency-pill"><i class="fa-solid fa-bolt" style="color:var(--crystal)"></i> <span id="uiCrystals">0</span></div>
            <div class="help-btn" onclick="openModal('tutHome')" style="margin-left:5px;">?</div>
        </div>
    </div>

    <div class="content">
        <!-- HOME -->
        <div id="tab-home" class="tab-view">
            <div class="card" style="background: linear-gradient(135deg, #4f46e5, #9333ea); color:white; border:none; position:relative; overflow:hidden;">
                <i class="fa-solid fa-gem" style="position:absolute; right:-10px; bottom:-10px; font-size:80px; opacity:0.1;"></i>
                <div style="position:relative; z-index:2;">
                    <div style="font-size:10px; background:rgba(255,255,255,0.2); width:fit-content; padding:2px 6px; border-radius:4px; margin-bottom:5px;">LIVE EVENT</div>
                    <h3>Crystal Hunt</h3>
                    <div style="font-size:11px; opacity:0.9; margin-bottom:10px;">Play Hardcore. Earn Rank & Crystals!</div>
                    <div class="grid-2" style="margin-bottom:15px;">
                        <button class="btn btn-sm" style="background:rgba(255,255,255,0.2); border:none; color:white;" onclick="eventCheckIn()">Check In</button>
                        <button class="btn btn-sm" style="background:white; border:none; color:var(--primary);" onclick="startGame('hardcore')">Hardcore</button>
                    </div>
                    
                    <!-- EVENT PROGRESSION UI -->
                    <div style="border-top:1px solid rgba(255,255,255,0.2); padding-top:10px;">
                        <div style="display:flex; justify-content:space-between; font-size:11px; margin-bottom:5px;">
                            <span>Rank: <b id="eventRankDisplay">Novice</b></span>
                            <span><span id="eventWins">0</span> Wins</span>
                        </div>
                        <div style="width:100%; height:4px; background:rgba(0,0,0,0.3); border-radius:10px; overflow:hidden;">
                            <div id="eventRankBar" style="height:100%; background:var(--gold); width:0%; transition:width 0.5s;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                   <div>
                       <span style="font-size:11px; color:var(--text-muted);">Career Level</span>
                       <div style="font-weight:800; font-size:18px;">Level <span id="homeLvl">1</span></div>
                   </div> 
                   <button class="btn btn-primary" style="width:auto; padding:8px 25px;" onclick="startGame('classic')">
                       <i class="fa-solid fa-play"></i> PLAY
                   </button>
                </div>
                <div style="margin-top:10px; font-size:10px; color:var(--text-muted);">XP Progress</div>
                <div style="width:100%; height:6px; background:var(--input-bg); border-radius:10px; margin-top:5px; overflow:hidden;">
                    <div id="homeXpBar" style="height:100%; background:var(--primary); width:0%; transition:width 0.5s;"></div>
                </div>
                
                <div style="border-top:1px solid var(--border); margin-top:15px; padding-top:10px; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <span style="font-size:11px; color:var(--text-muted);">Total Rank</span>
                        <div style="font-weight:800; font-size:14px; color:var(--accent);" id="homeRankDisplay">Novice</div>
                    </div>
                    <div style="font-size:10px; color:var(--text-muted);">Wins needed: <span id="nextRankReq">5</span></div>
                </div>
            </div>

            <h3 style="margin:20px 0 10px;">Missions</h3>
            <div class="mission-cat-bar">
                <div class="mission-tab active" onclick="setMissionTab('daily', this)">Daily</div>
                <div class="mission-tab" onclick="setMissionTab('event', this)">Event</div>
                <div class="mission-tab" onclick="setMissionTab('lifetime', this)">Lifetime</div>
            </div>
            <div id="missionList"></div>
        </div>

        <!-- SHOP -->
        <div id="tab-shop" class="tab-view hidden">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h2 style="font-family:var(--font-head);">Marketplace</h2>
                <div class="help-btn" onclick="openModal('tutShop')">?</div>
            </div>

            <div class="grid-2" style="margin-bottom:15px;">
                <button class="btn" onclick="checkCalendar()"><i class="fa-solid fa-calendar-check" style="color:var(--gold)"></i> Daily</button>
                <button class="btn" onclick="openModal('spinnerModal')"><i class="fa-solid fa-dharmachakra" style="color:var(--accent)"></i> Spinner</button>
            </div>
            
            <div class="card" style="border-color:var(--crystal);">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h4 style="color:var(--crystal)">Event Shop</h4>
                    <div style="font-size:11px;">Bal: <span id="shopCrystalBal">0</span> <i class="fa-solid fa-bolt" style="color:var(--crystal)"></i></div>
                </div>
                <div class="grid-3" id="shopRedeem"></div>
            </div>

            <h4 style="margin:15px 0 10px; color:var(--text-muted); font-size:12px;">POWER UPS</h4>
            <div class="grid-2" id="shopConsumables"></div>
            
            <h4 style="margin:15px 0 10px; color:var(--text-muted); font-size:12px;">COSMETICS</h4>
            <div class="grid-2" id="shopCosmetics"></div>
        </div>
        
        <!-- LEADERBOARD -->
        <div id="tab-leaderboard" class="tab-view hidden">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                 <h2 style="font-family:var(--font-head);">Global Top 10</h2>
                 <button class="btn btn-sm" onclick="refreshLeaderboard()"><i class="fa-solid fa-rotate"></i></button>
            </div>
            <p style="font-size:12px; color:var(--text-muted); margin-bottom:20px;">Ranked by Total XP. Login to save score.</p>
            <div id="leaderboardList">
                <div style="padding:20px; text-align:center; color:var(--text-muted);">Loading...</div>
            </div>
            <div class="card" style="margin-top:20px;">
                <h4 style="margin-bottom:10px;">Your Ranking</h4>
                <div style="font-size:12px; color:var(--text-muted);">Your Score: <b style="color:var(--primary); font-size:14px;"><span id="myLbScore">0</span> XP</b></div>
            </div>
        </div>

        <!-- PROFILE -->
        <div id="tab-profile" class="tab-view hidden">
            <div style="display:flex; justify-content:flex-end;">
                 <div class="help-btn" onclick="openModal('settingsModal')"><i class="fa-solid fa-gear"></i></div>
            </div>
            <div class="card" style="text-align:center; margin-top:10px;">
                <div style="position: relative; display: inline-block; width: 90px; height: 90px;">
                    <div id="profileFrame" style="position:absolute; inset:-5px; border-radius:50%; z-index:2; pointer-events:none;"></div>
                    <img id="profileAvatar" src="" style="width:100%; height:100%; border-radius:50%; border:2px solid var(--border); background:white;">
                    <div class="online-badge"></div>
                </div>
                <h2 style="margin-top:10px;" id="profileName">Guest</h2>
                <div style="font-size:12px; color:var(--text-muted); margin-bottom:10px;">Level <span id="profileLvl">1</span> • <span id="profileRank">Novice</span></div>
                <div id="profileBioDisplay" style="font-size:12px; color:var(--text); font-style:italic; margin-bottom:15px; padding:0 15px; opacity:0.8;"></div>
                
                <div class="grid-2" id="loginArea">
                    <button class="btn btn-primary" onclick="openModal('authModal')">Login / Save</button>
                    <button class="btn" onclick="openEditProfile()">Edit Profile</button>
                </div>
                <button class="btn" style="margin-top:10px;" onclick="openModal('inventoryModal')">Inventory</button>
            </div>
            
            <div class="card">
                <h4 style="margin-bottom:10px;">Statistics</h4>
                <div style="display:flex; justify-content:space-between; font-size:13px; padding:5px 0; border-bottom:1px solid var(--border);"><span>Classic Wins</span> <span id="statWins">0</span></div>
                <div style="display:flex; justify-content:space-between; font-size:13px; padding:5px 0; border-bottom:1px solid var(--border);"><span>Hardcore Wins</span> <span id="statHardWins">0</span></div>
                <div style="display:flex; justify-content:space-between; font-size:13px; padding:5px 0;"><span>Total XP</span> <span id="statXp">0</span></div>
            </div>

            <div class="device-footer" id="deviceFooter">Running on Unknown Device</div>
        </div>
    </div>

    <div class="dock-container">
        <div class="dock">
            <i class="fa-solid fa-house active" onclick="switchTab('home', this)"></i>
            <i class="fa-solid fa-store" onclick="switchTab('shop', this)"></i>
            <i class="fa-solid fa-trophy" onclick="switchTab('leaderboard', this)"></i>
            <i class="fa-solid fa-user" onclick="switchTab('profile', this)"></i>
        </div>
    </div>
  </div>

  <!-- MODALS -->
  <div class="overlay" id="authModal">
      <div class="modal">
          <h3>Save Progress</h3>
          <p style="font-size:12px; color:var(--text-muted); margin-bottom:20px;">Sync progress across devices.</p>
          <div id="authMenu">
              <button class="btn" style="background:white; color:black; border:1px solid #ddd; margin-bottom:10px;" onclick="googleLogin()"><i class="fa-brands fa-google"></i> Sign in with Google</button>
              <button class="btn" onclick="showEmailForm()"><i class="fa-solid fa-envelope"></i> Sign in with Email</button>
          </div>
          <div id="emailForm" class="hidden">
              <input type="email" id="authEmail" class="custom-input" placeholder="Email">
              <input type="password" id="authPass" class="custom-input" placeholder="Password">
              <div class="grid-2" style="margin-top:10px;">
                  <button class="btn btn-primary" onclick="emailAuth('login')">Login</button>
                  <button class="btn" onclick="emailAuth('signup')">Sign Up</button>
              </div>
              <div style="margin-top:10px; font-size:11px; color:var(--text-muted); cursor:pointer;" onclick="hideEmailForm()">Back</div>
          </div>
          <button class="btn" style="margin-top:20px; border:none; background:transparent;" onclick="closeModal('authModal')">Cancel</button>
      </div>
  </div>

  <div class="overlay" id="gameModal">
      <!-- Fullscreen Game UI -->
      <div class="modal game-fullscreen">
          <div style="position: absolute; top: 15px; left: 15px; right: 15px; display:flex; justify-content:space-between; align-items:center;">
              <span id="gameModeBadge" style="font-size:12px; background:var(--accent); color:white; padding:4px 10px; border-radius:8px; font-weight:bold; box-shadow:0 4px 10px rgba(0,0,0,0.2);">HARDCORE</span>
              <div class="help-btn" onclick="endGame(false)" style="background:rgba(255,255,255,0.9); color:var(--text); box-shadow:0 4px 10px rgba(0,0,0,0.1);"><i class="fa-solid fa-xmark"></i></div>
          </div>
          
          <div id="hardcoreTimer" style="position: absolute; top: 60px; left: 20px; right: 20px;" class="timer-bar-bg hidden"><div id="timerFill" class="timer-bar-fill"></div></div>
          
          <div style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; width:100%;">
             <div style="width:240px; height:240px; background:white; border-radius:30px; padding:30px; display:flex; align-items:center; justify-content:center; box-shadow:0 20px 50px rgba(0,0,0,0.1); margin-bottom:30px; position:relative;">
                  <img id="gameImg" style="width:100%; height:100%; object-fit:contain;">
                  <div id="gameOverlay" style="position:absolute; inset:0; background:rgba(255,255,255,0.95); border-radius:30px; display:flex; align-items:center; justify-content:center; flex-direction:column; opacity:0; pointer-events:none; transition:0.3s;">
                      <i id="gameIcon" class="fa-solid fa-check" style="font-size:50px; color:#10b981; margin-bottom:10px;"></i>
                      <div id="gameMsg" style="font-weight:800; font-size:20px;">Correct!</div>
                  </div>
             </div>
             
             <div style="width:100%; max-width:320px; padding:0 20px;">
                  <input type="text" id="gInput" class="custom-input" style="text-align:center; font-size:20px; letter-spacing:1px; padding:18px; border-radius:20px; box-shadow:0 10px 30px rgba(0,0,0,0.05);" placeholder="TYPE LOGO NAME..." autocomplete="off">
                  <button class="btn btn-primary" style="margin-top:15px; padding:16px; font-size:16px; border-radius:18px;" onclick="submitGuess()">SUBMIT GUESS</button>
             </div>
          </div>

          <!-- Power Ups Menu -->
          <div style="position: absolute; bottom: 0; left: 0; width: 100%; background: var(--dock-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); padding: 20px; border-top-left-radius: 24px; border-top-right-radius: 24px; border-top: 1px solid var(--border); display: flex; gap: 15px; justify-content: center;">
              <div class="item-box" style="width:70px; height:70px;" onclick="useHint()">
                   <i class="fa-solid fa-lightbulb" style="color:var(--gold); font-size:20px;"></i>
                   <div style="font-size:10px; margin-top:5px; font-weight:bold;">Hint</div>
                   <div style="font-size:9px; color:var(--text-muted);" id="gameHintCount">0</div>
              </div>
              <div class="item-box" style="width:70px; height:70px; opacity:0.5;">
                   <i class="fa-solid fa-forward" style="color:var(--primary); font-size:20px;"></i>
                   <div style="font-size:10px; margin-top:5px; font-weight:bold;">Skip</div>
                   <div style="font-size:9px; color:var(--text-muted);">Coming Soon</div>
              </div>
          </div>
      </div>
  </div>

  <!-- SETUP/EDIT PROFILE MODAL -->
  <div class="overlay" id="setupModal">
      <div class="modal">
          <h3>Edit Profile</h3>
          <div class="tab-nav">
              <div class="tab-btn active" onclick="switchSetupTab('details', this)">Details</div>
              <div class="tab-btn" onclick="switchSetupTab('avatar', this)">Avatar</div>
              <div class="tab-btn" onclick="switchSetupTab('frame', this)">Frame</div>
          </div>

          <!-- TAB: DETAILS -->
          <div id="setupTab-details" class="tab-content active">
              <input id="setupName" class="custom-input" placeholder="Username">
              <textarea id="setupBio" class="custom-textarea" placeholder="Short bio (max 60 chars)" maxlength="60"></textarea>
          </div>

          <!-- TAB: AVATAR -->
          <div id="setupTab-avatar" class="tab-content">
              <div style="margin-bottom:15px;">
                  <img id="setupAvatarPreview" src="" style="width:80px; height:80px; border-radius:50%; border:2px solid var(--primary); background:white;">
              </div>
              <div class="avatar-carousel" style="margin:10px 0;">
                  <button class="carousel-btn" onclick="changeAvatar(-1)"><i class="fa-solid fa-chevron-left"></i></button>
                  <span style="font-size:12px;">Browse</span>
                  <button class="carousel-btn" onclick="changeAvatar(1)"><i class="fa-solid fa-chevron-right"></i></button>
              </div>
              <div style="margin-top:15px; border-top:1px solid var(--border); padding-top:10px;">
                   <label style="font-size:11px; font-weight:bold; color:var(--text-muted);">OR UPLOAD</label>
                   <input type="file" id="avatarUpload" accept="image/*" style="font-size:11px; margin-top:5px; width:100%;" onchange="handleImageUpload(this)">
              </div>
          </div>

          <!-- TAB: FRAME -->
          <div id="setupTab-frame" class="tab-content">
              <div id="frameSelector" class="grid-3" style="max-height:200px; overflow-y:auto;"></div>
          </div>
          
          <button class="btn btn-primary" style="margin-top:20px;" onclick="saveProfile()">Save Changes</button>
          <button class="btn" style="margin-top:10px;" onclick="closeModal('setupModal')">Cancel</button>
      </div>
  </div>

  <div class="overlay" id="inventoryModal">
      <div class="modal">
          <h3>Your Inventory</h3>
          <div id="invGrid" class="grid-3" style="margin-top:15px;"></div>
          <button class="btn" style="margin-top:20px;" onclick="closeModal('inventoryModal')">Close</button>
      </div>
  </div>

  <div class="overlay" id="spinnerModal">
      <div class="modal">
          <h3>Lucky Spin</h3>
          <div style="width:200px; height:200px; border-radius:50%; background:conic-gradient(var(--accent) 0deg 60deg, var(--primary) 60deg 120deg, var(--gold) 120deg 180deg, #10b981 180deg 240deg, #a855f7 240deg 300deg, #3b82f6 300deg 360deg); margin:20px auto; border:5px solid var(--card); box-shadow:0 0 20px rgba(0,0,0,0.1); transition:transform 4s;" id="theWheel"></div>
          <button class="btn btn-primary" id="spinBtn" onclick="spinWheel()">SPIN NOW</button>
          <button class="btn" style="margin-top:15px;" onclick="closeModal('spinnerModal')">Close</button>
      </div>
  </div>

  <div class="overlay" id="calendarModal">
      <div class="modal">
          <h3>Daily Login</h3>
          <p style="font-size:12px; color:var(--text-muted); margin-bottom:15px;">Login daily for rewards. Miss a day and it resets!</p>
          <div class="cal-grid" id="calGrid"></div>
          <button class="btn btn-primary" id="claimCalBtn" style="margin-top:20px;" onclick="claimCalendar()">Claim Today's Reward</button>
          <button class="btn" style="margin-top:10px;" onclick="closeModal('calendarModal')">Close</button>
      </div>
  </div>

  <div class="overlay" id="settingsModal">
    <div class="modal">
        <h3>Settings</h3>
        <div style="text-align:left; margin:15px 0;">
             <label style="font-size:11px; color:var(--text-muted); margin-bottom:5px; display:block;">Now Playing: <span id="musicLabel" style="color:var(--primary);">None</span></label>
             <select class="custom-input" id="bgmSelect" onchange="changeBGM(this.value)">
                 <option value="1">EDM Gaming</option>
                 <option value="2">Funk Sigilo</option>
                 <option value="3">Sempero</option>
             </select>
             <input type="range" id="volSlider" min="0" max="1" step="0.1" value="0.5" style="width:100%; margin-top:10px;" onchange="changeVol(this.value)">
        </div>
        <button class="btn" onclick="toggleSetting('music')">Music: <span id="stMusic">OFF</span></button>
        <button class="btn" style="margin-top:8px;" onclick="toggleDarkMode()">Toggle Dark Mode</button>
        
        <div id="logoutBtnArea" class="hidden" style="margin-top:15px; border-top:1px solid var(--border); padding-top:10px;">
             <button class="btn" style="background:#ef4444; border-color:#ef4444; color:white;" onclick="firebase.auth().signOut().then(()=>window.location.reload())">Log Out</button>
        </div>
        
        <button class="btn" style="margin-top:10px;" onclick="closeModal('settingsModal')">Close</button>
    </div>
  </div>

  <div class="overlay" id="tutHome"><div class="modal"><h3>How to Play</h3><p style="font-size:13px; margin:15px 0;">Guess logos. Classic gives Coins/XP. Hardcore gives Crystals/Rank.</p><button class="btn" onclick="closeModal('tutHome')">Got it</button></div></div>
  <div class="overlay" id="tutShop"><div class="modal"><h3>Shop Guide</h3><p style="font-size:13px; margin:15px 0;">Use Coins for powerups/themes. Use Crystals for rare frames.</p><button class="btn" onclick="closeModal('tutShop')">Got it</button></div></div>
  <div class="overlay" id="tutLeaderboard"><div class="modal"><h3>Leaderboard</h3><p style="font-size:13px; margin:15px 0;">Compete with others for the top spot by earning XP!</p><button class="btn" onclick="closeModal('tutLeaderboard')">Got it</button></div></div>
  <div class="overlay" id="tutProfile"><div class="modal"><h3>Profile</h3><p style="font-size:13px; margin:15px 0;">Customize your avatar, frame, and bio here.</p><button class="btn" onclick="closeModal('tutProfile')">Got it</button></div></div>

  <script>
    const firebaseConfig = { apiKey: "AIzaSyAbKxS6HUPn1c632CMPzvLQiJBw57vqflQ", authDomain: "studio-4144954497-c3ea9.firebaseapp.com", projectId: "studio-4144954497-c3ea9" };
    
    // --- INIT ---
    window.addEventListener('DOMContentLoaded', () => {
        try { firebase.initializeApp(firebaseConfig); firebase.auth().onAuthStateChanged(u => { if(u) syncCloud(u); }); } catch(e){}
        try { loadData(); } catch(e) { resetData(); }
        setTimeout(() => removeSplash(), 2000);
        document.body.addEventListener('click', initAudio, {once:true});
        detectDevice();
        if(!state.user.setupComplete) { document.getElementById('setupWizard').classList.remove('hidden'); randomWizAvatar(); }
        
        // Show tutorial for current tab if not seen
        checkTutorial('home');
    });

    function removeSplash() { document.getElementById('splash').classList.add('hidden'); document.getElementById('app').classList.add('loaded'); renderAll(); }
    
    function detectDevice() {
        const ua = navigator.userAgent; let os="Unknown", ver="";
        if (/Android/.test(ua)) { os="Android"; const m=ua.match(/Android\s([0-9\.]+)/); if(m) ver=m[1]; }
        else if (/iPhone|iPad/.test(ua)) { os="iOS"; const m=ua.match(/OS\s([0-9_]+)/); if(m) ver=m[1].replace(/_/g,'.'); }
        document.getElementById('deviceFooter').innerText = `V1.3.2-R • Running on ${os} ${ver}`;
    }

    // --- DATA ---
    const AVATARS = ['Felix','Aneka','Zack','Midnight','Luna','Jack','Leo','Bella','Shadow','Pixel','Rocky','Ginger','Tiger']; 
    const RANKS = [{n:'Novice', w:0}, {n:'Rookie', w:5}, {n:'Pro', w:15}, {n:'Elite', w:30}, {n:'Master', w:50}, {n:'Legend', w:100}];
    const LOGOS = [
        {n:'Apple',d:'apple.com'}, {n:'Google',d:'google.com'}, {n:'Microsoft',d:'microsoft.com'}, 
        {n:'Amazon',d:'amazon.com'}, {n:'Netflix',d:'netflix.com'}, {n:'Spotify',d:'spotify.com'},
        {n:'Facebook',d:'facebook.com'}, {n:'Instagram',d:'instagram.com'}, {n:'Twitter',d:'twitter.com'},
        {n:'Tesla',d:'tesla.com'}, {n:'Nike',d:'nike.com'}, {n:'McDonalds',d:'mcdonalds.com'}
    ];
    const ITEMS = [
        { id:'hint', n:'Hint Token', type:'consumable', cost:50, curr:'coins', icon:'fa-lightbulb' },
        { id:'xp_boost', n:'XP Boost', type:'consumable', cost:100, curr:'coins', icon:'fa-arrow-up' },
        { id:'frame_neon', n:'Neon', type:'frame', cost:50, curr:'crystals', css:'border:3px solid #0ff; box-shadow:0 0 10px #0ff;' },
        { id:'frame_gold', n:'Gold Halo', type:'frame', cost:100, curr:'crystals', css:'border:3px solid #f59e0b; box-shadow:0 0 15px #f59e0b;' },
        { id:'th_gold', n:'Gold Theme', type:'theme', cost:500, curr:'coins', val:'Gold', icon:'fa-palette' }
    ];
    const MISSIONS = [
        { id:'d1', type:'daily', desc:'Play 5 Games', target:5, rwd:50, curr:'coins' },
        { id:'d2', type:'daily', desc:'Win 3 Hardcore', target:3, rwd:100, curr:'coins' },
        { id:'e1', type:'event', desc:'Collect 50 Crystals', target:50, rwd:10, curr:'gems' },
        { id:'e2', type:'event', desc:'Win 5 Event Games', target:5, rwd:100, curr:'coins' },
        { id:'l1', type:'lifetime', desc:'Reach Level 5', target:5, rwd:500, curr:'coins' },
        { id:'l2', type:'lifetime', desc:'Win 100 Games', target:100, rwd:20, curr:'gems' }
    ];

    // --- STATE ---
    let state = {
        user: { name:'Guest', uid:null, avatarIdx:0, customAvatar:null, frame:null, theme:'', bio:'', setupComplete:false },
        wallet: { coins:200, gems:5, crystals:0 },
        stats: { lvl:1, xp:0, wins:0, gamesPlayed:0, hardcoreWins:0 },
        inv: {}, missionProg: { e1:0, e2:0 }, 
        daily: { lastLogin:'', streak:0, lastSpin:0, lastEvent:'', lastCalClaim:0 },
        settings: { music:false, bgm:'1', darkMode:false, volume:0.5 },
        tutorials: { home:false, shop:false, leaderboard:false, profile:false },
        claimedMissions: []
    };
    
    let tempAvatarIdx = 0, tempCustomAvatar = null, tempFrame = null;
    let audioCtx = null, currentGame = null, gameMode = 'classic', gameTimerInt = null, currentMissionTab = 'daily';

    // --- AUDIO & SETUP ---
    function initAudio() { if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); updateAudioState(); }
    function updateAudioState() {
        ['1','2','3'].forEach(k=> document.getElementById('bgMusic_'+k).pause());
        const target = document.getElementById('bgMusic_'+state.settings.bgm);
        const names = {'1':'EDM Gaming', '2':'Funk Sigilo', '3':'Sempero'};
        document.getElementById('musicLabel').innerText = names[state.settings.bgm] || 'Track '+state.settings.bgm;
        
        if(state.settings.music && target) { 
            if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
            target.volume = state.settings.volume;
            target.play().catch(e=>console.log("Audio waiting"));
        }
        document.getElementById('stMusic').innerText = state.settings.music ? 'ON' : 'OFF';
    }
    function toggleSetting(k) { if(k==='music') { state.settings.music = !state.settings.music; updateAudioState(); } saveData(); }
    function changeBGM(v) { state.settings.bgm=v; updateAudioState(); saveData(); }
    function changeVol(v) { 
        state.settings.volume=v; 
        if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
        const target = document.getElementById('bgMusic_'+state.settings.bgm);
        if(target) target.volume = v; // Update current track volume immediately
        saveData(); 
    }

    function randomWizAvatar() { tempAvatarIdx = Math.floor(Math.random()*AVATARS.length); document.getElementById('wizAvatar').src = `https://api.dicebear.com/9.x/adventurer/svg?seed=${AVATARS[tempAvatarIdx]}`; }
    function finishWizard(save) { if(save) { const n=document.getElementById('wizName').value; if(n) state.user.name=n; state.user.avatarIdx=tempAvatarIdx; } state.user.setupComplete=true; saveData(); renderAll(); document.getElementById('setupWizard').classList.add('hidden'); }

    // --- EDIT PROFILE ---
    function openEditProfile() {
        tempAvatarIdx = state.user.avatarIdx; tempCustomAvatar = state.user.customAvatar; tempFrame = state.user.frame;
        document.getElementById('setupName').value = state.user.name;
        document.getElementById('setupBio').value = state.user.bio || '';
        updateSetupPreview(); renderFrameSelector();
        switchSetupTab('details', document.querySelector('.tab-btn'));
        openModal('setupModal');
    }
    function switchSetupTab(tabName, btn) { document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active')); document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); document.getElementById('setupTab-'+tabName).classList.add('active'); btn.classList.add('active'); }
    function renderFrameSelector() {
        const div = document.getElementById('frameSelector');
        div.innerHTML = `<div class="item-box" onclick="selectFrame(null)" style="${!tempFrame?'border-color:var(--primary)':''}">None</div>`;
        ITEMS.filter(i => i.type === 'frame').forEach(i => {
            if(state.inv[i.id]) div.innerHTML += `<div class="item-box" onclick="selectFrame('${i.id}')" style="${tempFrame===i.id?'border-color:var(--primary)':''}"> <div style="width:20px; height:20px; border-radius:50%; ${i.css}"></div> <div style="font-size:10px; margin-top:5px;">${i.n}</div> </div>`;
        });
    }
    function selectFrame(id) { tempFrame = id; renderFrameSelector(); }
    function changeAvatar(d) { tempAvatarIdx+=d; if(tempAvatarIdx<0) tempAvatarIdx=AVATARS.length-1; if(tempAvatarIdx>=AVATARS.length) tempAvatarIdx=0; tempCustomAvatar=null; updateSetupPreview(); }
    function handleImageUpload(input) { if (input.files && input.files[0]) { if(input.files[0].size > 500000) return alert("File too large"); var r=new FileReader(); r.onload=function(e){tempCustomAvatar=e.target.result; updateSetupPreview();}; r.readAsDataURL(input.files[0]); } }
    function updateSetupPreview() { document.getElementById('setupAvatarPreview').src = tempCustomAvatar ? tempCustomAvatar : `https://api.dicebear.com/9.x/adventurer/svg?seed=${AVATARS[tempAvatarIdx]}`; }
    function saveProfile() { if(document.getElementById('setupName').value) state.user.name=document.getElementById('setupName').value; state.user.bio=document.getElementById('setupBio').value; state.user.avatarIdx=tempAvatarIdx; state.user.customAvatar=tempCustomAvatar; state.user.frame=tempFrame; saveData(); closeModal('setupModal'); renderAll(); }

    // --- GAMEPLAY ---
    function startGame(mode) {
        gameMode = mode; currentGame = LOGOS[Math.floor(Math.random()*LOGOS.length)];
        document.getElementById('gameImg').src = `https://logo.clearbit.com/${currentGame.d}`;
        document.getElementById('gInput').value = '';
        document.getElementById('gameModeBadge').className = mode === 'hardcore' ? '' : 'hidden';
        document.getElementById('hardcoreTimer').className = mode === 'hardcore' ? 'timer-bar-bg' : 'hidden';
        
        document.getElementById('gameOverlay').style.opacity = '0'; // Reset overlay
        document.getElementById('gameHintCount').innerText = state.inv['hint'] || 0;

        openModal('gameModal');
        if(mode === 'hardcore') {
            document.getElementById('timerFill').style.width = '100%'; let tl=20; setTimeout(()=>document.getElementById('timerFill').style.width='0%',100);
            clearInterval(gameTimerInt); gameTimerInt=setInterval(()=>{tl--; if(tl<=0){endGame(false); showToast("Time's Up!", "error");}},1000);
        }
    }
    function submitGuess() {
        const g = document.getElementById('gInput').value.trim().toLowerCase().replace(/[^a-z0-9]/g, '');
        const t = currentGame.n.toLowerCase().replace(/[^a-z0-9]/g, '');
        
        if(g === t) {
            let xp = gameMode==='classic'?100:20, coins=gameMode==='classic'?50:100;
            if(gameMode==='hardcore') { state.stats.hardcoreWins++; state.wallet.crystals+=10; state.missionProg['e2'] = (state.missionProg['e2']||0)+1; state.missionProg['e1'] = (state.missionProg['e1']||0)+10; } 
            else { state.stats.wins++; }
            state.wallet.coins += coins; state.stats.gamesPlayed++;
            addXp(xp); updateMissionProg();
            
            // Show Success UI inside Fullscreen
            document.getElementById('gameOverlay').style.opacity = '1';
            setTimeout(() => { endGame(true); showToast(`Correct! +${coins} Coins`, "success"); }, 1000);
        } else {
             showToast("Wrong!", "error");
             // Shake animation logic could go here
        }
    }
    function useHint() { if((state.inv['hint']||0) > 0) { state.inv['hint']--; document.getElementById('gInput').value = currentGame.n.substring(0, 2); document.getElementById('gameHintCount').innerText = state.inv['hint']; saveData(); } else showToast("No Hints!", "error"); }
    function endGame() { clearInterval(gameTimerInt); closeModal('gameModal'); saveData(); renderAll(); }
    
    function addXp(amount) {
        state.stats.xp += amount;
        if(state.stats.xp >= state.stats.lvl * 200) { state.stats.xp -= state.stats.lvl*200; state.stats.lvl++; showToast("Level Up!", "success"); }
    }
    function updateMissionProg() {
        // Increment mission progress logic can be added here
        saveData();
    }

    // --- LEADERBOARD & SYNC ---
    function saveScoreToCloud() {
        if(!state.user.uid) return;
        const db = firebase.firestore();
        db.collection('leaderboard').doc(state.user.uid).set({
            username: state.user.name, score: state.stats.xp, avatar: state.user.avatarIdx, timestamp: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
    }
    function refreshLeaderboard() {
        const list = document.getElementById('leaderboardList');
        list.innerHTML = '<div style="padding:20px; text-align:center;">Loading...</div>';
        firebase.firestore().collection('leaderboard').orderBy('score', 'desc').limit(10).get().then(snap => {
            list.innerHTML = ''; let rank=1;
            snap.forEach(doc => {
                const d = doc.data();
                list.innerHTML += `<div class="leader-row"><div class="leader-rank">#${rank++}</div><div class="leader-info"><img class="leader-avatar" src="https://api.dicebear.com/9.x/adventurer/svg?seed=${AVATARS[d.avatar]||'Felix'}"><div><div style="font-weight:700;font-size:12px;">${d.username}</div></div></div><div class="leader-score">${d.score} XP</div></div>`;
            });
            if(snap.empty) list.innerHTML='<div style="padding:20px;text-align:center;">No players yet!</div>';
        }).catch(e => list.innerHTML='<div style="padding:20px;text-align:center;color:red;">Error loading</div>');
    }
    function syncCloud(u) {
        state.user.uid = u.uid;
        document.getElementById('logoutBtnArea').classList.remove('hidden');
        document.getElementById('loginArea').classList.add('hidden');
        saveData(); refreshLeaderboard();
    }

    // --- RENDER ---
    function renderAll() {
        ['uiCoins','uiGems','uiCrystals'].forEach(k => document.getElementById(k).innerText = state.wallet[k.replace('ui','').toLowerCase()]);
        
        // Profile
        document.getElementById('profileName').innerText = state.user.name;
        document.getElementById('profileBioDisplay').innerText = state.user.bio || "No bio yet.";
        const src = state.user.customAvatar ? state.user.customAvatar : `https://api.dicebear.com/9.x/adventurer/svg?seed=${AVATARS[state.user.avatarIdx]}`;
        document.getElementById('profileAvatar').src = src;
        const f = ITEMS.find(x => x.id === state.user.frame);
        document.getElementById('profileFrame').style.cssText = f ? `position:absolute; inset:-5px; border-radius:50%; z-index:2; pointer-events:none; ${f.css}` : '';
        
        // Stats
        document.getElementById('homeLvl').innerText = state.stats.lvl;
        document.getElementById('profileLvl').innerText = state.stats.lvl;
        document.getElementById('homeXpBar').style.width = Math.min((state.stats.xp/(state.stats.lvl*200))*100, 100) + '%';
        let rank = RANKS.reduce((p,c) => state.stats.hardcoreWins >= c.w ? c.n : p, "Novice");
        document.getElementById('homeRankDisplay').innerText = rank;
        document.getElementById('profileRank').innerText = rank;
        document.getElementById('nextRankReq').innerText = RANKS.find(r=>r.w > state.stats.hardcoreWins)?.w || "Max";
        document.getElementById('statWins').innerText = state.stats.wins;
        document.getElementById('statHardWins').innerText = state.stats.hardcoreWins;
        document.getElementById('statXp').innerText = state.stats.xp;
        document.getElementById('myLbScore').innerText = state.stats.xp;
        
        // Event Stats
        document.getElementById('eventWins').innerText = state.stats.hardcoreWins;
        document.getElementById('eventRankDisplay').innerText = rank;
        let nextRankW = RANKS.find(r=>r.w > state.stats.hardcoreWins)?.w || 100;
        let prevRankW = 0; // Simplified
        let progress = ((state.stats.hardcoreWins - prevRankW) / (nextRankW - prevRankW)) * 100;
        document.getElementById('eventRankBar').style.width = Math.min(progress, 100) + '%';

        renderMissions(); renderShop(); renderInventoryModal();
    }

    function renderMissions() {
        const div = document.getElementById('missionList'); div.innerHTML = '';
        MISSIONS.filter(m => m.type === currentMissionTab).forEach(m => {
            let prog = 0;
            if(m.type === 'event') prog = state.missionProg[m.id] || 0; // Use manual tracking for events
            if(m.id==='l1') prog = state.stats.lvl; if(m.id==='l2') prog = state.stats.wins+state.stats.hardcoreWins;
            if(m.type === 'daily' && m.id==='d1') prog = state.stats.gamesPlayed; // Simplified daily logic reset needs implementation
            if(m.type === 'daily' && m.id==='d2') prog = state.stats.hardcoreWins;

            let btn = state.claimedMissions.includes(m.id) ? '<i class="fa-solid fa-check"></i>' : (prog>=m.target ? `<button class="btn btn-sm btn-primary" onclick="claimMission('${m.id}')">Claim</button>` : `${prog}/${m.target}`);
            div.innerHTML += `<div style="background:var(--card); padding:10px; border-radius:12px; border:1px solid var(--border); margin-bottom:8px; display:flex; justify-content:space-between; align-items:center;"><div style="font-size:12px;"><b>${m.desc}</b><br><span style="color:var(--text-muted)">${m.rwd} ${m.curr}</span></div><div>${btn}</div></div>`;
        });
    }

    function renderShop() {
        const [r, c, o] = ['shopRedeem','shopConsumables','shopCosmetics'].map(i=>document.getElementById(i)); [r,c,o].forEach(e=>e.innerHTML='');
        document.getElementById('shopCrystalBal').innerText = state.wallet.crystals;
        ITEMS.forEach(i => {
            const owned = state.inv[i.id]; const locked = !owned && state.wallet[i.curr] < i.cost;
            const icon = i.curr === 'coins' ? 'fa-coins' : (i.curr==='crystals'?'fa-bolt':'fa-gem'); const color = i.curr === 'coins' ? 'var(--gold)' : (i.curr==='crystals'?'var(--crystal)':'var(--gem)');
            let html = `<div class="item-box" onclick="buyItem('${i.id}')" style="opacity:${locked?0.7:1}"> ${owned ? '<div class="tag-owned"></div>' : ''} <i class="fa-solid ${i.icon||'fa-star'}" style="font-size:20px; color:var(--text-muted)"></i> <div style="font-size:11px; font-weight:700; margin-top:5px;">${i.n}</div> <div class="item-price"><i class="fa-solid ${icon}" style="color:${color}; font-size:9px;"></i> ${i.cost}</div> </div>`;
            if(i.curr==='crystals') r.innerHTML+=html; else if(i.type==='consumable') c.innerHTML+=html; else o.innerHTML+=html;
        });
    }

    function renderInventoryModal() {
        const grid = document.getElementById('invGrid'); grid.innerHTML = '';
        Object.keys(state.inv).forEach(k => {
            if(state.inv[k] > 0) { const item = ITEMS.find(x => x.id === k); if(item) grid.innerHTML += `<div class="item-box"><i class="fa-solid ${item.icon||'fa-box'}" style="margin-bottom:5px;"></i><div>${item.n}</div><div style="font-size:10px; color:var(--text-muted)">x${state.inv[k]}</div></div>`; }
        });
        if(grid.innerHTML === '') grid.innerHTML = '<div style="grid-column:span 3; color:var(--text-muted); font-size:11px;">Inventory is empty.</div>';
    }

    // --- ACTIONS ---
    function claimMission(id) { let m=MISSIONS.find(x=>x.id===id); state.wallet[m.curr]+=m.rwd; state.claimedMissions.push(id); showToast("Claimed!", "success"); saveData(); renderAll(); }
    function buyItem(id) { let i=ITEMS.find(x=>x.id===id); if(state.wallet[i.curr]>=i.cost) { state.wallet[i.curr]-=i.cost; state.inv[id]=(state.inv[id]||0)+1; saveData(); renderAll(); showToast(`Bought ${i.n}`, "success"); } else showToast("Need Funds", "error"); }
    function setMissionTab(t, el) { currentMissionTab=t; document.querySelectorAll('.mission-tab').forEach(x=>x.classList.remove('active')); el.classList.add('active'); renderMissions(); }

    // --- SYSTEM UTILS ---
    function showToast(msg, type) { const t=document.createElement('div'); t.className=`toast`; if(type==='error') t.style.borderLeftColor='#ef4444'; t.innerText=msg; document.getElementById('toastContainer').appendChild(t); setTimeout(()=>t.remove(),2500); }
    function switchTab(id, el) { 
        document.querySelectorAll('.tab-view').forEach(t=>t.classList.add('hidden')); 
        document.getElementById('tab-'+id).classList.remove('hidden'); 
        document.querySelectorAll('.dock i').forEach(i=>i.classList.remove('active')); 
        el.classList.add('active'); 
        if(id==='leaderboard') refreshLeaderboard();
        checkTutorial(id);
    }
    
    function checkTutorial(id) {
        if (!state.tutorials[id]) {
            let tutId = 'tut' + id.charAt(0).toUpperCase() + id.slice(1);
            if(document.getElementById(tutId)) openModal(tutId);
            state.tutorials[id] = true;
            saveData();
        }
    }

    function openModal(id) { document.getElementById(id).classList.add('open'); }
    function closeModal(id) { document.getElementById(id).classList.remove('open'); }
    
    function googleLogin() { const p=new firebase.auth.GoogleAuthProvider(); firebase.auth().signInWithPopup(p).then(()=>{closeModal('authModal');showToast("Welcome!","success")}).catch(e=>showToast(e.message,"error")); }
    function showEmailForm() { document.getElementById('authMenu').classList.add('hidden'); document.getElementById('emailForm').classList.remove('hidden'); }
    function hideEmailForm() { document.getElementById('emailForm').classList.add('hidden'); document.getElementById('authMenu').classList.remove('hidden'); }
    function emailAuth(type) { const e=document.getElementById('authEmail').value,p=document.getElementById('authPass').value; const a=firebase.auth(); const pr=type==='signup'?a.createUserWithEmailAndPassword(e,p):a.signInWithEmailAndPassword(e,p); pr.then(()=>{closeModal('authModal');showToast("Success!","success")}).catch(r=>showToast(r.message,"error")); }
    
    function saveData() { try{localStorage.setItem('guessit_v132r', JSON.stringify(state)); if(state.user.uid) saveScoreToCloud();}catch(e){} }
    function loadData() { const d=localStorage.getItem('guessit_v132r'); if(d) { state={...state, ...JSON.parse(d)}; if(state.user.theme) document.body.setAttribute('data-theme',state.user.theme); if(state.settings.darkMode) document.body.classList.add('dark-mode'); } }
    function resetData() { localStorage.removeItem('guessit_v132r'); window.location.reload(); }
    function toggleDarkMode() { document.body.classList.toggle('dark-mode'); state.settings.darkMode=!state.settings.darkMode; saveData(); }
    
    // Calendar & Spin
    function checkCalendar() { 
        openModal('calendarModal'); 
        const g=document.getElementById('calGrid'); g.innerHTML='';
        const icons = ['fa-coins', 'fa-coins', 'fa-bolt', 'fa-coins', 'fa-bolt', 'fa-gem', 'fa-gift'];
        const rwds = ['50', '100', '10', '150', '20', '10', 'BIG'];
        
        for(let i=0; i<7; i++) {
            let status = i < state.daily.streak ? 'claimed' : (i===state.daily.streak ? 'active' : '');
            let icon = icons[i];
            let rwd = rwds[i];
            
            g.innerHTML += `<div class="cal-day ${status}">
                <div style="font-weight:bold; font-size:9px; color:var(--text-muted);">Day ${i+1}</div>
                <i class="fa-solid ${icon}" style="color:${status==='active'?'white':'var(--gold)'}"></i>
                <div style="font-weight:800;">${rwd}</div>
            </div>`;
        }
    }
    
    function claimCalendar() { const now=Date.now(); if(now-state.daily.lastCalClaim>86400000){ state.daily.streak=(state.daily.streak+1)%8; state.daily.lastCalClaim=now; state.wallet.gems+=5; showToast("Claimed Rewards!","success"); saveData(); checkCalendar(); } else showToast("Come back tomorrow","error"); }
    function spinWheel() { const now=Date.now(); if(now-state.daily.lastSpin>3600000){ state.daily.lastSpin=now; document.getElementById('theWheel').style.transform=`rotate(${1000+Math.random()*1000}deg)`; setTimeout(()=>{ state.wallet.coins+=100; showToast("Won 100 Coins!","success"); saveData(); renderAll(); closeModal('spinnerModal'); },3000); } else showToast("Wait 1 hour","error"); }
    function eventCheckIn() { const t=new Date().toDateString(); if(state.daily.lastEvent!==t){ state.daily.lastEvent=t; state.wallet.crystals+=5; showToast("+5 Crystals","success"); saveData(); renderAll(); } else showToast("Already Checked In","error"); }
  </script>
</body>
</html>
