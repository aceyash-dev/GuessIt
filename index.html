<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="theme-color" content="#0f172a">
  <title>Guess It! V1.4.0 (Schema Integrated)</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Space+Grotesk:wght@300;500;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    /* --- VARIABLES --- */
    :root {
      --bg: #f8fafc; --card: rgba(255, 255, 255, 0.85); --border: rgba(99, 102, 241, 0.15);
      --text: #0f172a; --text-muted: #64748b; --primary: #4f46e5; --primary-glow: rgba(79, 70, 229, 0.3);
      --accent: #f43f5e; --gold: #f59e0b; --crystal: #8b5cf6; --gem: #0ea5e9; 
      --ticket: #f97316; 
      --font-head: 'Space Grotesk', sans-serif; --font-body: 'Outfit', sans-serif;
      --modal-bg: rgba(255, 255, 255, 0.95); --input-bg: #f1f5f9; --dock-bg: rgba(255, 255, 255, 0.9);
      --shadow: 0 10px 40px -10px rgba(0,0,0,0.1);
      --success: #10b981; --error: #ef4444;
    }
    body.dark-mode {
      --bg: #020617; --card: rgba(30, 41, 59, 0.85); --border: rgba(99, 102, 241, 0.3);
      --text: #f8fafc; --text-muted: #94a3b8; --input-bg: rgba(255, 255, 255, 0.05);
      --modal-bg: rgba(15, 23, 42, 0.95); --dock-bg: rgba(15, 23, 42, 0.9);
      --shadow: 0 10px 40px -10px rgba(0,0,0,0.3);
    }
    /* THEMES */
    body[data-theme="Gold"] { --bg: #281c04; --card: rgba(60, 40, 10, 0.9); --primary: #d97706; --border: #fcd34d; }
    body[data-theme="DarkKnight"] { --bg: #000000; --card: rgba(20, 20, 20, 0.9); --primary: #333; --accent: #fff; --text: #eee; --border: #444; }
    body[data-theme="CottonCandy"] { --bg: #fff0f5; --card: rgba(255, 255, 255, 0.8); --primary: #ff69b4; --accent: #87ceeb; --text: #555; --border: #ffb6c1; }
    body[data-theme="Matrix"] { --bg: #000; --card: rgba(0, 20, 0, 0.9); --primary: #00ff00; --text: #00ff00; --text-muted: #008800; --border: #004400; --accent: #fff; font-family: monospace; }
    body[data-theme="Cyberpunk"] { --bg: #0f0014; --card: rgba(20, 0, 30, 0.9); --primary: #f0f; --accent: #0ff; --text: #fff; --border: #f0f; }

    * { box-sizing: border-box; margin: 0; padding: 0; font-family: var(--font-body); user-select: none; -webkit-tap-highlight-color: transparent; }
    body { background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; font-size: 14px; transition: background 0.4s ease, color 0.4s ease; position: relative; }

    .bg-fx { position: fixed; inset: 0; z-index: -1; background: radial-gradient(circle at 50% 0%, var(--primary-glow) 0%, transparent 60%); opacity: 0.6; pointer-events: none; }
    
    /* ANIMATIONS */
    @keyframes popIn { 0% { opacity:0; transform: scale(0.9) translateY(10px); } 100% { opacity:1; transform: scale(1) translateY(0); } }
    .stagger-anim > * { opacity: 0; animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
    .stagger-anim > *:nth-child(1) { animation-delay: 0.05s; }
    .stagger-anim > *:nth-child(2) { animation-delay: 0.1s; }
    .stagger-anim > *:nth-child(3) { animation-delay: 0.15s; }
    .stagger-anim > *:nth-child(4) { animation-delay: 0.2s; }
    .stagger-anim > *:nth-child(5) { animation-delay: 0.25s; }
    .stagger-anim > *:nth-child(6) { animation-delay: 0.3s; }

    /* SPLASH */
    .splash { position: fixed; inset: 0; z-index: 9999; background: linear-gradient(135deg, #000000, #4338ca, #be185d, #000000); background-size: 400% 400%; animation: rgbGlow 8s ease infinite; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.6s ease-out, visibility 0.6s; }
    .splash.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
    @keyframes rgbGlow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

    .cube-wrap { perspective: 800px; width: 60px; height: 60px; margin-bottom: 30px; }
    .cube { width: 100%; height: 100%; transform-style: preserve-3d; animation: spin 6s infinite linear; }
    .face { position: absolute; width: 60px; height: 60px; background: rgba(255,255,255,0.1); border: 2px solid white; display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; box-shadow: 0 0 20px rgba(255,255,255,0.5); font-weight: 900; backface-visibility: visible; }
    .f1 { transform: translateZ(30px); } .f2 { transform: rotateY(180deg) translateZ(30px); } .f3 { transform: rotateY(90deg) translateZ(30px); } .f4 { transform: rotateY(-90deg) translateZ(30px); } .f5 { transform: rotateX(90deg) translateZ(30px); } .f6 { transform: rotateX(-90deg) translateZ(30px); }
    @keyframes spin { 0% { transform: rotateX(0) rotateY(0); } 100% { transform: rotateX(360deg) rotateY(360deg); } }

    /* LAYOUT */
    .app { max-width: 480px; margin: 0 auto; height: 100%; display: flex; flex-direction: column; opacity: 0; transition: opacity 0.5s; }
    .app.loaded { opacity: 1; }
    .content { flex: 1; overflow-y: auto; padding: 15px 15px 120px 15px; scroll-behavior: smooth; }
    .content::-webkit-scrollbar { display: none; }

    /* COMPONENTS */
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 24px; padding: 20px; margin-bottom: 12px; backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); box-shadow: var(--shadow); position: relative; overflow: hidden; transition: transform 0.2s; }
    .btn { background: var(--input-bg); color: var(--text); border: 1px solid var(--border); padding: 14px; border-radius: 18px; font-weight: 800; cursor: pointer; width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; font-family: var(--font-head); font-size: 13px; text-transform: uppercase; transition: all 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
    .btn:active { transform: scale(0.96); }
    .btn-primary { background: var(--primary); border-color: var(--primary); color: white; box-shadow: 0 6px 20px var(--primary-glow); }
    .btn-sm { padding: 8px 14px; font-size: 11px; width: auto; border-radius: 12px; }
    
    .currency-pill { background: var(--input-bg); border: 1px solid var(--border); padding: 6px 12px; border-radius: 20px; font-size: 11px; display: flex; align-items: center; gap: 6px; font-weight: 700; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .mission-cat-bar, .shop-nav-bar { display: flex; gap: 8px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; }
    .mission-tab, .shop-tab-btn { padding: 8px 16px; border-radius: 20px; background: var(--input-bg); color: var(--text-muted); font-size: 11px; font-weight: bold; cursor: pointer; border: 1px solid transparent; white-space: nowrap; transition: 0.2s; }
    .mission-tab.active, .shop-tab-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 15px var(--primary-glow); }

    /* GRID & ITEMS */
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .item-box { background: var(--input-bg); border: 1px solid var(--border); padding: 12px; border-radius: 20px; text-align: center; cursor: pointer; position: relative; transition: 0.2s; display:flex; flex-direction:column; align-items:center; justify-content:center; }
    .item-box:active { transform: scale(0.96); }
    .item-price { font-size: 11px; display: flex; align-items: center; justify-content: center; gap: 4px; margin-top: 6px; font-weight: 700; color:var(--text); }
    .tag-owned { position: absolute; top: 8px; right: 8px; width: 8px; height: 8px; background: #10b981; border-radius: 50%; box-shadow: 0 0 5px #10b981; }
    .preview-btn { position: absolute; top: 5px; left: 5px; width: 24px; height: 24px; background: var(--card); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; color: var(--text-muted); border: 1px solid var(--border); z-index: 5; }
    
    .online-badge { position: absolute; bottom: 2px; right: 2px; width: 14px; height: 14px; background: #10b981; border: 2px solid var(--card); border-radius: 50%; z-index: 10; box-shadow: 0 0 8px rgba(16,185,129,0.5); }
    .avatar-carousel { display: flex; align-items: center; justify-content: center; gap: 15px; margin: 20px 0; }
    .carousel-btn { width: 36px; height: 36px; border-radius: 50%; background: var(--primary); color: white; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 10px var(--primary-glow); }

    /* MODALS & TABS */
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.3s; backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); }
    .overlay.open { opacity: 1; pointer-events: auto; }
    .modal { background: var(--modal-bg); width: 90%; max-width: 380px; padding: 25px; border-radius: 32px; border: 1px solid var(--border); text-align: center; max-height: 85vh; overflow-y: auto; position: relative; box-shadow: 0 25px 60px rgba(0,0,0,0.3); transform: scale(0.95) translateY(10px); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    .overlay.open .modal { transform: scale(1) translateY(0); }
    .game-fullscreen { width: 100% !important; height: 100% !important; max-width: none !important; max-height: none !important; border-radius: 0 !important; display: flex; flex-direction: column; justify-content: center; padding-bottom: 80px !important; background: var(--bg); }

    .tab-nav { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 20px; }
    .tab-btn { flex: 1; padding: 12px; font-size: 13px; font-weight: 700; color: var(--text-muted); cursor: pointer; border-bottom: 3px solid transparent; transition:0.2s; }
    .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
    .tab-content { display: none; }
    .tab-content.active { display: block; animation: popIn 0.3s; }

    .timer-bar-bg { width: 100%; height: 8px; background: var(--input-bg); border-radius: 10px; margin: 10px 0; overflow: hidden; }
    .timer-bar-fill { height: 100%; background: var(--accent); width: 100%; transition: width 0.1s linear; border-radius: 10px; }
    .help-btn { width: 32px; height: 32px; border-radius: 50%; border: 1px solid var(--border); background: var(--card); color: var(--text-muted); display: flex; align-items: center; justify-content: center; font-size: 14px; cursor: pointer; transition:0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

    /* LEADERBOARD & CALENDAR */
    .cal-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 15px; }
    .cal-day { background: var(--input-bg); padding: 15px 5px; border-radius: 16px; font-size: 10px; border:1px solid var(--border); position: relative; transition: 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px; }
    .cal-day.active { background: var(--primary); color: white; border-color:var(--primary); box-shadow:0 4px 15px var(--primary-glow); transform: scale(1.05); z-index: 2; }
    .cal-day.claimed { opacity: 0.5; background: var(--card); filter: grayscale(1); }
    .cal-day i { font-size: 16px; margin-bottom: 2px; }

    /* DOCK */
    .dock-container { position: fixed; bottom: 20px; left: 0; width: 100%; display: flex; justify-content: center; z-index: 100; pointer-events: none; }
    .dock { background: var(--dock-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); padding: 14px 30px; border-radius: 30px; display: flex; gap: 30px; border: 1px solid var(--border); pointer-events: auto; box-shadow: 0 15px 40px rgba(0,0,0,0.1); }
    .dock i { font-size: 22px; color: var(--text-muted); transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); cursor: pointer; width:40px; text-align:center; }
    .dock i.active { color: var(--primary); transform: translateY(-8px) scale(1.2); }
    .device-footer { text-align: center; font-size: 10px; color: var(--text-muted); margin-top: 15px; opacity: 0.6; padding-bottom: 5px; }

    /* TOAST */
    .hidden { display: none !important; }
    #toastContainer { position: fixed; top: 15px; left: 50%; transform: translateX(-50%); z-index: 99999; display: flex; flex-direction: column; gap: 10px; width: auto; min-width: 280px; pointer-events: none; }
    .toast { background: rgba(15, 23, 42, 0.95); padding: 12px 20px; border-radius: 50px; font-weight: 600; font-size: 13px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); animation: slideDown 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); color: white; display:flex; align-items:center; gap:12px; backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); overflow: hidden; position: relative; }
    .toast-progress { position: absolute; bottom: 0; left: 0; height: 3px; background: rgba(255,255,255,0.3); width: 100%; animation: shrink 2.5s linear forwards; }
    @keyframes shrink { from { width: 100%; } to { width: 0%; } }
    @keyframes slideDown { from { transform: translateY(-30px) scale(0.9); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
    
    .custom-input, .custom-textarea { width: 100%; background: var(--input-bg); border: 1px solid var(--border); padding: 16px; border-radius: 18px; color: var(--text); outline: none; margin-top: 5px; font-weight:600; transition:0.2s; }
    .custom-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-glow); }
    .custom-textarea { resize: none; height: 100px; font-family: var(--font-body); }
    
    /* SPINNER LABELS */
    .wheel-segment { position: absolute; width: 100%; height: 100%; transform-origin: center; display:flex; justify-content:center; padding-top:15px; }
    .wheel-label-text { font-size: 10px; font-weight: 800; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.5); transform: rotate(0deg); }

    /* BATTLE PASS TRACK */
    .bp-track { display: flex; gap: 0; margin-top: 15px; overflow-x: auto; padding-bottom: 10px; scroll-behavior: smooth; }
    .bp-level { min-width: 80px; position: relative; display: flex; flex-direction: column; gap: 8px; align-items: center; }
    .bp-level::after { content:''; position: absolute; top: 50%; right: -25px; width: 50px; height: 2px; background: var(--border); z-index: 0; }
    .bp-level:last-child::after { display: none; }
    .bp-reward-node { width: 50px; height: 50px; border-radius: 12px; background: var(--input-bg); border: 2px solid var(--border); display: flex; align-items: center; justify-content: center; position: relative; z-index: 1; transition: 0.2s; font-size: 18px; color: var(--text-muted); }
    .bp-reward-node.claimed { background: var(--success); color: white; border-color: var(--success); }
    .bp-reward-node.locked { opacity: 0.5; }
    .bp-reward-node.ready { border-color: var(--primary); box-shadow: 0 0 10px var(--primary-glow); animation: pulse 1.5s infinite; }
    .bp-qty { position: absolute; bottom: -2px; right: -2px; background: rgba(0,0,0,0.7); color: white; font-size: 9px; padding: 2px 4px; border-radius: 6px; font-weight: 800; backdrop-filter: blur(2px); border: 1px solid rgba(255,255,255,0.2); }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    .bp-gold-row { border: 2px solid var(--gold); box-shadow: 0 0 10px rgba(245, 158, 11, 0.2); background: rgba(245, 158, 11, 0.1); }

    /* NEW PROFILE STATS GRID */
    .stat-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 15px; }
    .stat-item { background: var(--input-bg); padding: 12px 5px; border-radius: 16px; text-align: center; border: 1px solid var(--border); cursor: pointer; transition: 0.2s; }
    .stat-item:active { transform: scale(0.95); }
    .stat-val { font-weight: 800; font-size: 16px; margin-bottom: 2px; }
    .stat-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; font-weight: bold; }

    /* GOLD PASS SPECIALS */
    @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
    .gold-nameplate { background: linear-gradient(90deg, #b45309, #fbbf24, #b45309); background-size: 200% auto; animation: shimmer 3s linear infinite; -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 900 !important; }
    .gold-glow { box-shadow: 0 0 15px rgba(251, 191, 36, 0.5); border-color: #fbbf24 !important; }
    .rank-row { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid var(--border); font-size: 12px; align-items: center; }
    .rank-row.reached { color: var(--primary); font-weight: bold; }
    
    .section-header { font-size: 11px; font-weight: 800; color: var(--text-muted); margin: 20px 0 10px; text-transform: uppercase; letter-spacing: 1px; }

  </style>
</head>
<body>

  <audio id="bgMusic_1" loop preload="none"><source src="http://googleusercontent.com/file_content/2" type="audio/mpeg"></audio> 
  <audio id="bgMusic_2" loop preload="none"><source src="http://googleusercontent.com/file_content/0" type="audio/mpeg"></audio> 
  <audio id="bgMusic_3" loop preload="none"><source src="http://googleusercontent.com/file_content/1" type="audio/mpeg"></audio> 
  <audio id="bgMusic_4" loop preload="none"><source src="FunkSigiloSlowed.mp3" type="audio/mpeg"></audio> 
  <audio id="bgMusic_5" loop preload="none"><source src="edm-gaming-music-335408.mp3" type="audio/mpeg"></audio> 
  <audio id="bgMusic_6" loop preload="none"><source src="SEMPERO_Slowed_KLICKAUD.mp3" type="audio/mpeg"></audio>

  <div id="toastContainer"></div>
  <div class="bg-fx"></div>

  <div class="splash" id="splash">
    <div class="cube-wrap"><div class="cube"><div class="face f1">G</div><div class="face f2">?</div><div class="face f3">!</div><div class="face f4">#</div><div class="face f5"></div><div class="face f6"></div></div></div>
    <h1 style="color:white; letter-spacing:4px; font-weight:800; font-size:32px;">GUESS IT!</h1>
    <div style="color:rgba(255,255,255,0.7); font-size:12px; margin-top:5px; font-family:var(--font-head);">V1.4.0 • Schema Integrated</div>
  </div>

  <div class="wizard hidden" id="setupWizard" style="position:fixed; inset:0; background:var(--bg); z-index:3000; display:flex; flex-direction:column; padding:30px; align-items:center; justify-content:center; transition:0.3s;">
      <div style="max-width:320px; width:100%; text-align:center;">
          <h2 style="font-family:var(--font-head); font-size:28px; margin-bottom:10px;">Welcome!</h2>
          <p style="color:var(--text-muted); margin-bottom:30px;">Let's get your profile ready.</p>
          <div style="width:100px; height:100px; margin:0 auto 20px; border-radius:50%; background:var(--input-bg); border:4px solid var(--primary); overflow:hidden; box-shadow:0 10px 30px var(--primary-glow);">
              <img id="wizAvatar" src="" style="width:100%; height:100%;">
          </div>
          <button class="btn btn-sm" onclick="randomWizAvatar(); triggerHaptic();" style="margin:0 auto 20px; width:auto;"><i class="fa-solid fa-shuffle"></i> Randomize</button>
          <input id="wizName" class="custom-input" placeholder="Enter Username" style="text-align:center;">
          <button class="btn btn-primary" style="margin-top:20px;" onclick="finishWizard(true); triggerHaptic();">Looks Good!</button>
          <button class="btn" style="margin-top:15px; background:transparent; border:none; color:var(--text-muted);" onclick="finishWizard(false)">Skip</button>
      </div>
  </div>

  <div class="app" id="app">
    <div style="padding: 15px; display: flex; justify-content: space-between; align-items: center;">
        <div style="font-family: var(--font-head); font-weight: 800; font-size: 18px; display: flex; align-items: center; gap: 8px;">
            <i class="fa-solid fa-cube" style="color:var(--primary)"></i> GUESS IT!
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
            <div class="currency-pill"><i class="fa-solid fa-coins" style="color:var(--gold)"></i> <span id="uiCoins">0</span></div>
            <div class="currency-pill"><i class="fa-regular fa-gem" style="color:var(--gem)"></i> <span id="uiGems">0</span></div>
            <div class="currency-pill"><i class="fa-solid fa-bolt" style="color:var(--crystal)"></i> <span id="uiCrystals">0</span></div>
            <div class="help-btn" onclick="openModal('tutHome'); triggerHaptic();" style="margin-left:5px;">?</div>
        </div>
    </div>

    <div class="content">
        <div id="tab-home" class="tab-view">
            <div class="card" style="background: linear-gradient(135deg, #4f46e5, #9333ea); color:white; border:none; position:relative; overflow:hidden;">
                <i class="fa-solid fa-gem" style="position:absolute; right:-10px; bottom:-10px; font-size:120px; opacity:0.1; transform:rotate(-20deg);"></i>
                <div style="position:relative; z-index:2;">
                    <div style="font-size:10px; background:rgba(255,255,255,0.25); width:fit-content; padding:4px 8px; border-radius:6px; margin-bottom:8px; font-weight:700;">LIVE EVENT</div>
                    <h3>Crystal Hunt</h3>
                    <div style="font-size:11px; opacity:0.9; margin-bottom:15px; line-height:1.4;">Play Hardcore. Earn Rank & Crystals!<br>Limited Time Only.</div>
                    
                    <div style="margin-bottom:15px;">
                        <div style="display:flex; justify-content:space-between; font-size:10px; margin-bottom:4px; opacity:0.8;">
                             <span>Rank Progress</span> <span id="hcRankProgText">0/5</span>
                        </div>
                        <div style="width:100%; height:6px; background:rgba(255,255,255,0.2); border-radius:10px; overflow:hidden;">
                            <div id="hcProgressBar" style="height:100%; background:white; width:0%; transition:width 0.5s;"></div>
                        </div>
                    </div>

                    <div class="grid-2" style="margin-bottom:20px;">
                        <button class="btn btn-sm" style="background:rgba(255,255,255,0.2); border:none; color:white;" onclick="eventCheckIn(); triggerHaptic();"><i class="fa-solid fa-calendar-check"></i> Check In</button>
                        <button class="btn btn-sm" style="background:white; border:none; color:var(--primary);" onclick="startGame('hardcore'); triggerHaptic();"><i class="fa-solid fa-play"></i> Hardcore</button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                   <div onclick="openModal('rankModal'); triggerHaptic();" style="cursor:pointer;">
                       <span style="font-size:11px; color:var(--text-muted); font-weight:600;">CAREER LEVEL</span>
                       <div style="font-weight:800; font-size:24px;">Level <span id="homeLvl">1</span> <i class="fa-solid fa-circle-info" style="font-size:12px; color:var(--text-muted)"></i></div>
                   </div> 
                   <button class="btn btn-primary" style="width:auto; padding:10px 28px;" onclick="startGame('classic'); triggerHaptic();">
                       <i class="fa-solid fa-play"></i> PLAY
                   </button>
                </div>
                <div style="margin-top:15px; font-size:10px; color:var(--text-muted); font-weight:600;">XP PROGRESS</div>
                <div style="width:100%; height:8px; background:var(--input-bg); border-radius:10px; margin-top:5px; overflow:hidden;">
                    <div id="homeXpBar" style="height:100%; background:var(--primary); width:0%; transition:width 0.5s;"></div>
                </div>
            </div>

            <h3 style="margin:25px 0 10px;">Missions</h3>
            <div class="mission-cat-bar">
                <div class="mission-tab active" onclick="setMissionTab('daily', this); triggerHaptic();">Daily</div>
                <div class="mission-tab" onclick="setMissionTab('event', this); triggerHaptic();">Event</div>
                <div class="mission-tab" onclick="setMissionTab('lifetime', this); triggerHaptic();">Lifetime</div>
            </div>
            <div id="missionList" class="stagger-anim"></div>
        </div>

        <div id="tab-shop" class="tab-view hidden">
            <h2 style="font-family:var(--font-head); margin-bottom:15px;">Shop</h2>
            
            <div class="shop-nav-bar">
                <div class="shop-tab-btn active" onclick="setShopTab('gifts', this)">Gifts</div>
                <div class="shop-tab-btn" onclick="setShopTab('exchange', this)">Exchange</div>
                <div class="shop-tab-btn" onclick="setShopTab('themes', this)">Themes</div>
                <div class="shop-tab-btn" onclick="setShopTab('badges', this)">Badges</div>
                <div class="shop-tab-btn" onclick="setShopTab('frames', this)">Frames</div>
            </div>

            <div id="shop-gifts" class="shop-section stagger-anim">
                <div class="card" style="background:linear-gradient(45deg, #4f46e5, #06b6d4); color:white; text-align:center;">
                    <i class="fa-solid fa-box-open" style="font-size:40px; margin-bottom:10px; color:white;"></i>
                    <h3>Mystery Box</h3>
                    <p style="font-size:12px; margin-bottom:15px; opacity:0.9;">Contains Random Rewards (Coins, Gems, or Rare Items).</p>
                    <button class="btn btn-sm" id="btnMystery" style="background:white; color:var(--primary); border:none;" onclick="claimMysteryBox(); triggerHaptic();">Open Free (24h)</button>
                    <div id="mysteryTimer" style="font-size:10px; margin-top:5px; font-weight:bold;"></div>
                </div>

                <div class="grid-2">
                    <button class="btn" onclick="checkCalendar(); triggerHaptic();"><i class="fa-solid fa-calendar-check" style="color:var(--gold)"></i> Calendar</button>
                    <button class="btn" onclick="openModal('spinnerModal'); triggerHaptic();"><i class="fa-solid fa-dharmachakra" style="color:var(--accent)"></i> Spinner</button>
                </div>
                
                <div class="section-header">Crystal Items</div>
                <div class="grid-3" id="shopRedeem"></div>
            </div>

            <div id="shop-exchange" class="shop-section hidden stagger-anim">
                <div class="card">
                    <h4>Currency Exchange</h4>
                    <p style="font-size:11px; color:var(--text-muted); margin-bottom:15px;">Swap your earnings.</p>
                    <div style="display:flex; justify-content:space-between; align-items:center; background:var(--input-bg); padding:10px; border-radius:12px; margin-bottom:10px;">
                        <div><i class="fa-solid fa-coins" style="color:var(--gold)"></i> 1000</div>
                        <i class="fa-solid fa-arrow-right"></i>
                        <div><i class="fa-regular fa-gem" style="color:var(--gem)"></i> 10</div>
                        <button class="btn btn-sm btn-primary" style="width:auto; margin-left:10px;" onclick="exchangeCurr('c2g')">Exch</button>
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center; background:var(--input-bg); padding:10px; border-radius:12px;">
                        <div><i class="fa-regular fa-gem" style="color:var(--gem)"></i> 10</div>
                        <i class="fa-solid fa-arrow-right"></i>
                        <div><i class="fa-solid fa-coins" style="color:var(--gold)"></i> 500</div>
                        <button class="btn btn-sm btn-primary" style="width:auto; margin-left:10px;" onclick="exchangeCurr('g2c')">Exch</button>
                    </div>
                </div>
                <div class="section-header">Power Ups (Coins)</div>
                <div class="grid-2" id="shopConsumables"></div>
            </div>

            <div id="shop-themes" class="shop-section hidden grid-2 stagger-anim"></div>
            <div id="shop-badges" class="shop-section hidden grid-2 stagger-anim"></div>
            
            <div id="shop-frames" class="shop-section hidden">
                 <div class="section-header">Exclusive Frames</div>
                 <div id="shop-frames-grid" class="grid-2"></div>
            </div>

        </div>
        
        <div id="tab-pass" class="tab-view hidden">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                 <h2 style="font-family:var(--font-head);">Season Pass</h2>
                 <div class="currency-pill"><i class="fa-solid fa-ticket-simple" style="color:var(--ticket)"></i> <span id="passTicketCount">0</span> Tickets</div>
            </div>

            <div class="card" style="background: linear-gradient(90deg, #1c1300, #3d2600); border:1px solid #f59e0b; margin-bottom:20px;">
                <div style="display:flex; justify-content:space-between; align-items:center; color:#fcd34d;">
                    <div>
                        <div style="font-weight:900; font-size:18px; letter-spacing:1px; display:flex; align-items:center; gap:5px;">
                            GOLD PASS <i class="fa-solid fa-crown"></i>
                        </div>
                        <div style="font-size:11px; opacity:0.8; margin-top:2px;">Season 1 • <span id="gpExpText">7 Days Left</span></div>
                    </div>
                </div>
                
                <div id="passTrackContainer" style="margin-top:15px; overflow-x:auto;">
                    <div class="bp-track" id="bpTrack"></div>
                </div>

                <div class="grid-2" style="margin-top:15px;">
                    <button id="btnGoldPass" class="btn btn-sm" style="background:#f59e0b; border:none; color:black; font-weight:800;" onclick="buyGoldPass(); triggerHaptic();">Unlock Gold (100 Gems)</button>
                    <button id="btnGoldTrial" class="btn btn-sm" style="background:rgba(245, 158, 11, 0.2); border:1px solid #f59e0b; color:#fcd34d; font-weight:800;" onclick="buyGoldTrial(); triggerHaptic();">Try Gold (5 Gems/6h)</button>
                </div>
            </div>
            
            <div class="card">
                <h4>How to Level Up</h4>
                <p style="font-size:12px; color:var(--text-muted); margin-top:5px;">Complete <b>Event</b> and <b>Lifetime</b> missions to earn Tickets <i class="fa-solid fa-ticket-simple"></i>. Collect Tickets to unlock Pass Tiers.</p>
            </div>
        </div>

        <div id="tab-profile" class="tab-view hidden">
            <div style="display:flex; justify-content:flex-end; gap:10px; margin-bottom:10px;">
                 <div class="help-btn" onclick="openModal('vaultModal'); triggerHaptic();"><i class="fa-solid fa-box-archive"></i></div>
                 <div class="help-btn" onclick="openModal('settingsModal'); triggerHaptic();"><i class="fa-solid fa-gear"></i></div>
            </div>
            
            <div class="card" style="text-align:center; padding-bottom:25px;">
                <div style="display:flex; flex-direction:column; align-items:center;">
                    <div style="position: relative; display: inline-block; width: 110px; height: 110px; margin-bottom:10px;">
                        <div id="profileFrame" style="position:absolute; inset:-8px; border-radius:50%; z-index:2; pointer-events:none;"></div>
                        <img id="profileAvatar" src="" style="width:100%; height:100%; border-radius:50%; border:4px solid var(--border); background:white;">
                        <div class="online-badge" style="width:20px; height:20px; border-width:3px;"></div>
                    </div>
                    <h2 style="font-size:24px; margin-bottom:2px;" id="profileName">Guest</h2>
                    
                    <div onclick="openModal('rankModal'); triggerHaptic();" style="font-size:12px; color:var(--primary); font-weight:700; background:rgba(79, 70, 229, 0.1); padding:4px 12px; border-radius:12px; cursor:pointer; margin-top:5px;">Level <span id="profileLvl">1</span> • <span id="profileRank">Novice</span> <i class="fa-solid fa-chevron-right" style="font-size:10px;"></i></div>
                </div>

                <div id="profileBioDisplay" style="font-size:13px; color:var(--text-muted); font-style:italic; margin:15px 0 20px; padding:0 20px; line-height:1.4;"></div>
                <div id="profileBadges" style="display:flex; justify-content:center; gap:8px; margin-bottom:20px; min-height:16px;"></div>

                <div class="stat-row">
                    <div class="stat-item" onclick="openModal('rankModal'); triggerHaptic();">
                        <div class="stat-val" style="color:var(--success)" id="statWins">0</div>
                        <div class="stat-label">Wins</div>
                    </div>
                    <div class="stat-item" onclick="openModal('rankModal'); triggerHaptic();">
                        <div class="stat-val" style="color:var(--accent)" id="statHardWins">0</div>
                        <div class="stat-label">Hardcore</div>
                    </div>
                    <div class="stat-item" onclick="openModal('rankModal'); triggerHaptic();">
                        <div class="stat-val" style="color:var(--primary)" id="statXp">0</div>
                        <div class="stat-label">Total XP</div>
                    </div>
                </div>

                <div class="grid-2">
                    <div id="loginArea">
                        <button class="btn btn-primary" onclick="openModal('authModal'); triggerHaptic();">Login / Save</button>
                    </div>
                    <button class="btn" onclick="openEditProfile(); triggerHaptic();">Edit Profile</button>
                </div>
            </div>
            
            <div class="device-footer" id="deviceFooter">Running on Unknown Device</div>
        </div>
    </div>

    <div class="dock-container">
        <div class="dock">
            <i class="fa-solid fa-house active" onclick="switchTab('home', this); triggerHaptic();"></i>
            <i class="fa-solid fa-store" onclick="switchTab('shop', this); triggerHaptic();"></i>
            <i class="fa-solid fa-ticket" onclick="switchTab('pass', this); triggerHaptic();"></i>
            <i class="fa-solid fa-user" onclick="switchTab('profile', this); triggerHaptic();"></i>
        </div>
    </div>
  </div>

  <div class="overlay" id="authModal">
      <div class="modal">
          <h3>Save Progress</h3>
          <p style="font-size:12px; color:var(--text-muted); margin-bottom:20px;">Sync progress across devices.</p>
          <div id="authMenu">
              <button class="btn" style="background:white; color:black; border:1px solid #ddd; margin-bottom:10px;" onclick="googleLogin(); triggerHaptic();"><i class="fa-brands fa-google"></i> Sign in with Google</button>
              <button class="btn" onclick="showEmailForm(); triggerHaptic();"><i class="fa-solid fa-envelope"></i> Sign in with Email</button>
          </div>
          <div id="emailForm" class="hidden">
              <input type="email" id="authEmail" class="custom-input" placeholder="Email">
              <input type="password" id="authPass" class="custom-input" placeholder="Password">
              <div class="grid-2" style="margin-top:10px;">
                  <button class="btn btn-primary" onclick="emailAuth('login'); triggerHaptic();">Login</button>
                  <button class="btn" onclick="emailAuth('signup'); triggerHaptic();">Sign Up</button>
              </div>
              <div style="margin-top:10px; font-size:11px; color:var(--text-muted); cursor:pointer;" onclick="hideEmailForm()">Back</div>
          </div>
          <button class="btn" style="margin-top:20px; border:none; background:transparent; color:var(--text-muted);" onclick="closeModal('authModal')">Cancel</button>
      </div>
  </div>

  <div class="overlay" id="rankModal">
      <div class="modal">
          <h3>Rank List</h3>
          <p style="font-size:12px; color:var(--text-muted); margin-bottom:15px;">Win Hardcore games to rank up!</p>
          <div id="rankListContainer" style="text-align:left; max-height:300px; overflow-y:auto;"></div>
          <button class="btn" style="margin-top:20px;" onclick="closeModal('rankModal')">Close</button>
      </div>
  </div>

  <div class="overlay" id="gameModal">
      <div class="modal game-fullscreen">
          <div style="position: absolute; top: 15px; left: 15px; right: 15px; display:flex; justify-content:space-between; align-items:center;">
              <span id="gameModeBadge" style="font-size:12px; background:var(--accent); color:white; padding:4px 10px; border-radius:8px; font-weight:bold; box-shadow:0 4px 10px rgba(0,0,0,0.2);">HARDCORE</span>
              <div class="help-btn" onclick="endGame(false)" style="background:rgba(255,255,255,0.9); color:var(--text); box-shadow:0 4px 10px rgba(0,0,0,0.1);"><i class="fa-solid fa-xmark"></i></div>
          </div>
          <div id="hardcoreTimer" style="position: absolute; top: 60px; left: 20px; right: 20px;" class="timer-bar-bg hidden"><div id="timerFill" class="timer-bar-fill"></div></div>
          
          <div style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; width:100%;">
             <div style="width:280px; height:280px; background:white; border-radius:30px; padding:40px; display:flex; align-items:center; justify-content:center; box-shadow:0 25px 60px rgba(0,0,0,0.15); margin-bottom:40px; position:relative;">
                  <img id="gameImg" style="width:100%; height:100%; object-fit:contain;">
                  <div id="gameOverlay" style="position:absolute; inset:0; background:rgba(255,255,255,0.95); border-radius:30px; display:flex; align-items:center; justify-content:center; flex-direction:column; opacity:0; pointer-events:none; transition:0.3s;">
                      <i id="gameIcon" class="fa-solid fa-check" style="font-size:50px; color:#10b981; margin-bottom:10px;"></i>
                      <div id="gameMsg" style="font-weight:800; font-size:20px;">Correct!</div>
                  </div>
             </div>
             
             <div style="width:100%; max-width:340px; padding:0 20px;">
                  <input type="text" id="gInput" class="custom-input" style="text-align:center; font-size:24px; font-weight:800; text-transform:uppercase; letter-spacing:2px; padding:20px; border-radius:24px; box-shadow:0 10px 30px rgba(0,0,0,0.05);" placeholder="GUESS..." autocomplete="off">
                  <button class="btn btn-primary" style="margin-top:15px; padding:16px; font-size:16px; border-radius:18px;" onclick="submitGuess(); triggerHaptic();">SUBMIT</button>
             </div>
          </div>
          
          <div style="position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); background: var(--dock-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); padding: 12px; border-radius: 24px; border: 1px solid var(--border); display: flex; gap: 12px; justify-content: center; box-shadow: 0 20px 50px rgba(0,0,0,0.2);">
              <div class="item-box" style="width:64px; height:64px; border-radius:16px;" onclick="usePowerUp('hint'); triggerHaptic();"><i class="fa-solid fa-lightbulb" style="color:var(--gold); font-size:20px;"></i><div style="font-size:10px; margin-top:5px; font-weight:bold;">Hint</div><div style="font-size:9px; color:var(--text-muted);" id="gameHintCount">0</div></div>
              <div class="item-box" style="width:64px; height:64px; border-radius:16px;" onclick="usePowerUp('freeze'); triggerHaptic();"><i class="fa-solid fa-snowflake" style="color:var(--gem); font-size:20px;"></i><div style="font-size:10px; margin-top:5px; font-weight:bold;">Freeze</div><div style="font-size:9px; color:var(--text-muted);" id="gameFreezeCount">0</div></div>
              <div class="item-box" style="width:64px; height:64px; border-radius:16px;" onclick="usePowerUp('time'); triggerHaptic();"><i class="fa-solid fa-clock-rotate-left" style="color:var(--accent); font-size:20px;"></i><div style="font-size:10px; margin-top:5px; font-weight:bold;">+Time</div><div style="font-size:9px; color:var(--text-muted);" id="gameTimeCount">0</div></div>
          </div>
      </div>
  </div>

  <div class="overlay" id="setupModal">
      <div class="modal">
          <h3>Edit Profile</h3>
          <div class="tab-nav">
              <div class="tab-btn active" onclick="switchSetupTab('details', this)">Details</div>
              <div class="tab-btn" onclick="switchSetupTab('avatar', this)">Avatar</div>
              <div class="tab-btn" onclick="switchSetupTab('frame', this)">Frame</div>
          </div>
          <div id="setupTab-details" class="tab-content active"><input id="setupName" class="custom-input" placeholder="Username"><textarea id="setupBio" class="custom-textarea" placeholder="Short bio (max 60 chars)" maxlength="60"></textarea></div>
          <div id="setupTab-avatar" class="tab-content">
              <div style="margin-bottom:15px;"><img id="setupAvatarPreview" src="" style="width:100px; height:100px; border-radius:50%; border:3px solid var(--primary); background:white;"></div>
              <div class="avatar-carousel" style="margin:10px 0;"><button class="carousel-btn" onclick="changeAvatar(-1); triggerHaptic();"><i class="fa-solid fa-chevron-left"></i></button><span style="font-size:12px; margin:0 15px;">Browse</span><button class="carousel-btn" onclick="changeAvatar(1); triggerHaptic();"><i class="fa-solid fa-chevron-right"></i></button></div>
              <div style="margin-top:15px; border-top:1px solid var(--border); padding-top:10px;"><label style="font-size:11px; font-weight:bold; color:var(--text-muted);">OR UPLOAD</label><input type="file" id="avatarUpload" accept="image/*" style="font-size:11px; margin-top:5px; width:100%;" onchange="handleImageUpload(this)"></div>
          </div>
          <div id="setupTab-frame" class="tab-content"><div id="frameSelector" class="grid-3" style="max-height:220px; overflow-y:auto; padding:5px;"></div></div>
          <button class="btn btn-primary" style="margin-top:20px;" onclick="saveProfile(); triggerHaptic();">Save Changes</button>
          <button class="btn" style="margin-top:10px; background:transparent; border:none;" onclick="closeModal('setupModal')">Cancel</button>
      </div>
  </div>

  <div class="overlay" id="vaultModal">
      <div class="modal">
          <h3>Your Vault</h3>
          <div id="invGrid" class="grid-3" style="margin-top:15px;"></div>
          <button class="btn" style="margin-top:20px;" onclick="closeModal('vaultModal')">Close</button>
      </div>
  </div>

  <div class="overlay" id="previewModal">
      <div class="modal">
          <h3 id="prevTitle">Item Preview</h3>
          <div style="margin:20px auto; width:100px; height:100px; position:relative;">
              <div id="prevFrame" style="position:absolute; inset:-8px; border-radius:50%; pointer-events:none;"></div>
              <img src="https://api.dicebear.com/9.x/adventurer/svg?seed=Felix" style="width:100%; height:100%; border-radius:50%; background:white; border:3px solid var(--border);">
          </div>
          <p id="prevDesc" style="font-size:12px; color:var(--text-muted); margin-bottom:15px;"></p>
          <button class="btn btn-primary" id="prevBuyBtn">Buy Now</button>
          <button class="btn" style="margin-top:10px; background:transparent; border:none;" onclick="closeModal('previewModal')">Close</button>
      </div>
  </div>

  <div class="overlay" id="spinnerModal">
      <div class="modal">
          <h3>Lucky Spin</h3>
          <div style="position:relative; width:220px; height:220px; margin:30px auto;">
              <div id="theWheel" style="width:100%; height:100%; border-radius:50%; background:conic-gradient(#10b981 0deg 60deg, #3b82f6 60deg 120deg, #f59e0b 120deg 180deg, #f43f5e 180deg 240deg, #8b5cf6 240deg 300deg, #eab308 300deg 360deg); border:6px solid var(--card); box-shadow:0 0 30px rgba(0,0,0,0.1); transition:transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99);">
                  <div class="wheel-segment" style="transform: rotate(30deg);"><span class="wheel-label-text">1 GEM</span></div>
                  <div class="wheel-segment" style="transform: rotate(90deg);"><span class="wheel-label-text">3 GEM</span></div>
                  <div class="wheel-segment" style="transform: rotate(150deg);"><span class="wheel-label-text">20 G</span></div>
                  <div class="wheel-segment" style="transform: rotate(210deg);"><span class="wheel-label-text">50 G</span></div>
                  <div class="wheel-segment" style="transform: rotate(270deg);"><span class="wheel-label-text">5 GEM</span></div>
                  <div class="wheel-segment" style="transform: rotate(330deg);"><span class="wheel-label-text">100 G</span></div>
              </div>
              <div style="position:absolute; top:-15px; left:50%; width:24px; height:24px; background:white; clip-path: polygon(50% 0%, 0% 100%, 100% 100%); transform: translateX(-50%) rotate(180deg); z-index:5; filter:drop-shadow(0 2px 2px rgba(0,0,0,0.3));"></div>
          </div>
          <button class="btn btn-primary" id="spinBtn" onclick="spinWheel(); triggerHaptic();">SPIN NOW</button>
          <button class="btn" style="margin-top:15px; background:transparent; border:none;" onclick="closeModal('spinnerModal')">Close</button>
      </div>
  </div>

  <div class="overlay" id="calendarModal">
      <div class="modal">
          <h3>Daily Rewards</h3>
          <div class="cal-grid" id="calGrid"></div>
          <button class="btn btn-primary" id="claimCalBtn" style="margin-top:20px;" onclick="claimCalendar(); triggerHaptic();">Claim Today's Reward</button>
          <button class="btn" style="margin-top:10px; background:transparent; border:none;" onclick="closeModal('calendarModal')">Close</button>
      </div>
  </div>

  <div class="overlay" id="settingsModal">
    <div class="modal">
        <h3>Settings</h3>
        <div style="text-align:left; margin:20px 0;">
             <label style="font-size:11px; color:var(--text-muted); margin-bottom:5px; display:block;">Now Playing: <span id="musicLabel" style="color:var(--primary); font-weight:bold;">None</span></label>
             <select class="custom-input" id="bgmSelect" onchange="changeBGM(this.value)">
                 <option value="1">Sempero</option>
                 <option value="2">EDM Gaming</option>
                 <option value="3">Funk Sigilo</option>
                 <option value="4">Funk Sigilo (Slowed)</option>
                 <option value="5">User Mix (EDM)</option>
                 <option value="6">Sempero (Slowed)</option> </select>
             <input type="range" id="volSlider" min="0" max="1" step="0.1" value="0.5" style="width:100%; margin-top:15px;" onchange="changeVol(this.value)">
        </div>
        <div class="grid-2">
            <button class="btn" onclick="toggleSetting('music'); triggerHaptic();">Music: <span id="stMusic">OFF</span></button>
            <button class="btn" onclick="toggleSetting('haptics'); triggerHaptic();">Haptics: <span id="stHaptics">ON</span></button>
        </div>
        <button class="btn" style="margin-top:10px;" onclick="toggleDarkMode(); triggerHaptic();">Toggle Dark Mode</button>
        <div id="logoutBtnArea" class="hidden" style="margin-top:20px; border-top:1px solid var(--border); padding-top:15px;">
             <button class="btn" style="background:#ef4444; border-color:#ef4444; color:white;" onclick="firebase.auth().signOut().then(()=>window.location.reload())">Log Out</button>
        </div>
        <button class="btn" style="margin-top:10px; background:transparent; border:none;" onclick="closeModal('settingsModal')">Close</button>
    </div>
  </div>

  <div class="overlay" id="tutHome"><div class="modal"><h3>How to Play</h3><p style="font-size:13px; margin:15px 0; line-height:1.5; color:var(--text-muted);">Guess logos to win. <br><b>Classic:</b> Earn Coins & XP.<br><b>Hardcore:</b> Earn Crystals & Rank.</p><button class="btn btn-primary" onclick="closeModal('tutHome'); triggerHaptic();">Got it</button></div></div>
  <div class="overlay" id="tutShop"><div class="modal"><h3>Shop Guide</h3><p style="font-size:13px; margin:15px 0; line-height:1.5; color:var(--text-muted);"><b>Gifts:</b> Free Mystery Box daily.<br><b>Exchange:</b> Swap Coins & Gems.<br><b>Items:</b> Buy Themes & Frames.</p><button class="btn btn-primary" onclick="closeModal('tutShop'); triggerHaptic();">Got it</button></div></div>
  <div class="overlay" id="tutPass"><div class="modal"><h3>Season Pass</h3><p style="font-size:13px; margin:15px 0; line-height:1.5; color:var(--text-muted);">Earn <b>Tickets</b> from Event & Lifetime missions to level up the pass and unlock rewards.</p><button class="btn btn-primary" onclick="closeModal('tutPass'); triggerHaptic();">Got it</button></div></div>
  <div class="overlay" id="tutProfile"><div class="modal"><h3>Profile</h3><p style="font-size:13px; margin:15px 0; line-height:1.5; color:var(--text-muted);">Customize your avatar and frame. Login to sync progress across devices.</p><button class="btn btn-primary" onclick="closeModal('tutProfile'); triggerHaptic();">Got it</button></div></div>

  <script>
    /* --- INTEGRATED SCHEMA DEFINITION ---
    Ref: Firebase Data Connect / GraphQL Schema
    
    type User @table {
      username: String!
      email: String!
      createdAt: Timestamp!
      displayName: String
      photoUrl: String
      totalScore: Int
    }
    type Category @table { name: String!, createdAt: Timestamp!, description: String }
    type Question @table { category: Category, text: String!, correctAnswer: String!, createdAt: Timestamp!, imageUrl: String }
    type AnswerOption @table { question: Question, text: String!, isCorrect: Boolean! }
    type GameSession @table { singlePlayerUser: User, player1: User, player2: User, startTime: Timestamp!, gameMode: String!, status: String!, endTime: Timestamp, winnerId: UUID, totalScore: Int }
    type PlayerAnswer @table(key: ["gameSession", "user", "question"]) { gameSession: GameSession!, user: User!, question: Question!, selectedAnswerOptionId: UUID!, isCorrect: Boolean!, timeTaken: Int!, scoreAwarded: Int }
    */

    const firebaseConfig = { apiKey: "AIzaSyAbKxS6HUPn1c632CMPzvLQiJBw57vqflQ", authDomain: "studio-4144954497-c3ea9.firebaseapp.com", projectId: "studio-4144954497-c3ea9" };
    
    // --- INIT ---
    window.addEventListener('DOMContentLoaded', () => {
        try { firebase.initializeApp(firebaseConfig); firebase.auth().onAuthStateChanged(u => { if(u) syncCloud(u); }); } catch(e){}
        try { loadData(); } catch(e) { resetData(); }
        setTimeout(() => removeSplash(), 2000);
        // Optimization: Ensure AudioContext is resumed on user gesture
        document.body.addEventListener('click', () => { if(state.settings.music) initAudio(); }, {once:true});
        detectDevice();
        if(!state.user.setupComplete) { document.getElementById('setupWizard').classList.remove('hidden'); randomWizAvatar(); }
        setTimeout(() => checkTutorial('home'), 2200);
        checkGoldPass();
        renderShopTabs();
    });

    function removeSplash() { document.getElementById('splash').classList.add('hidden'); document.getElementById('app').classList.add('loaded'); renderAll(); }
    function detectDevice() {
        const ua = navigator.userAgent; let os="Unknown", ver="";
        if (/Android/.test(ua)) { os="Android"; const m=ua.match(/Android\s([0-9\.]+)/); if(m) ver=m[1]; }
        else if (/iPhone|iPad/.test(ua)) { os="iOS"; const m=ua.match(/OS\s([0-9_]+)/); if(m) ver=m[1].replace(/_/g,'.'); }
        document.getElementById('deviceFooter').innerText = `V1.4.0 • Running on ${os} ${ver}`;
    }

    // --- DATA ---
    const AVATARS = ['Felix','Aneka','Zack','Midnight','Luna','Jack','Leo','Bella','Shadow','Pixel','Rocky','Ginger','Tiger', 'GoldKing', 'GoldQueen']; 
    const RANKS = [{n:'Novice', w:0}, {n:'Rookie', w:5}, {n:'Pro', w:15}, {n:'Elite', w:30}, {n:'Master', w:50}, {n:'Legend', w:100}];
    const LOGOS = [
        {n:'Apple',d:'apple.com'}, {n:'Google',d:'google.com'}, {n:'Microsoft',d:'microsoft.com'}, 
        {n:'Amazon',d:'amazon.com'}, {n:'Netflix',d:'netflix.com'}, {n:'Spotify',d:'spotify.com'},
        {n:'Facebook',d:'facebook.com'}, {n:'Instagram',d:'instagram.com'}, {n:'Twitter',d:'twitter.com'},
        {n:'Tesla',d:'tesla.com'}, {n:'Nike',d:'nike.com'}, {n:'McDonalds',d:'mcdonalds.com'}
    ];
    
    // ITEMS & SHOP
    const ITEMS = [
        { id:'hint', n:'Hint Token', type:'consumable', cost:50, curr:'coins', icon:'fa-lightbulb' },
        { id:'freeze', n:'Freeze (5s)', type:'consumable', cost:100, curr:'coins', icon:'fa-snowflake' },
        { id:'time', n:'+10s Time', type:'consumable', cost:100, curr:'coins', icon:'fa-clock-rotate-left' },
        { id:'xp_boost', n:'XP Boost', type:'consumable', cost:150, curr:'coins', icon:'fa-arrow-up' },
        { id:'frame_neon', n:'Neon', type:'frame', cost:50, curr:'crystals', css:'border:3px solid #0ff; box-shadow:0 0 10px #0ff;' },
        { id:'frame_gold', n:'Gold Halo', type:'frame', cost:100, curr:'crystals', css:'border:3px solid #f59e0b; box-shadow:0 0 15px #f59e0b;' },
        { id:'frame_diamond', n:'Diamond', type:'frame', cost:200, curr:'crystals', css:'border:3px solid #b9f2ff; box-shadow:0 0 20px #b9f2ff, inset 0 0 10px #b9f2ff;' },
        { id:'frame_glitch', n:'Glitch', type:'frame', cost:300, curr:'crystals', css:'border:3px dashed #f0f; box-shadow:3px 3px 0 #0ff, -3px -3px 0 #f0f;' },
        { id:'frame_fire', n:'Inferno', type:'frame', cost:400, curr:'crystals', css:'border:3px solid #ef4444; box-shadow:0 0 20px #ef4444;' },
        { id:'frame_steampunk', n:'Steampunk', type:'frame', cost:150, curr:'crystals', css:'border:4px double #78350f; box-shadow:0 0 0 2px #d97706;' },
        { id:'frame_galaxy', n:'Galaxy', type:'frame', cost:250, curr:'crystals', css:'border:3px solid transparent; background:linear-gradient(#000, #000) padding-box, linear-gradient(45deg, #6366f1, #d946ef) border-box;' },
        { id:'frame_nature', n:'Nature', type:'frame', cost:120, curr:'crystals', css:'border:3px solid #22c55e; box-shadow: 0 5px 0 #15803d;' },
        { id:'frame_pixel', n:'Pixel', type:'frame', cost:180, curr:'crystals', css:'border:4px dashed #000; box-shadow: 4px 4px 0 rgba(0,0,0,0.5);' },
        { id:'frame_magma', n:'Magma', type:'frame', cost:450, curr:'crystals', css:'border:3px solid #7f1d1d; box-shadow:0 0 15px #f87171, inset 0 0 10px #f87171;' },
        { id:'th_gold', n:'Gold Theme', type:'theme', cost:500, curr:'coins', val:'Gold', icon:'fa-palette' },
        { id:'th_dark', n:'Dark Knight', type:'theme', cost:800, curr:'coins', val:'DarkKnight', icon:'fa-mask' },
        { id:'th_cotton', n:'Cotton Candy', type:'theme', cost:600, curr:'coins', val:'CottonCandy', icon:'fa-cloud' },
        { id:'th_matrix', n:'Matrix', type:'theme', cost:1000, curr:'coins', val:'Matrix', icon:'fa-code' },
        { id:'th_cyber', n:'Cyberpunk', type:'theme', cost:1200, curr:'coins', val:'Cyberpunk', icon:'fa-robot' },
        { id:'badge_verified', n:'Verified', type:'badge', cost:1000, curr:'coins', icon:'fa-check-circle' },
        { id:'badge_sniper', n:'Sniper', type:'badge', cost:2000, curr:'coins', icon:'fa-crosshairs' },
        { id:'badge_rich', n:'Rich', type:'badge', cost:5000, curr:'coins', icon:'fa-sack-dollar' }
    ];

    const MISSIONS = [
        { id:'d1', type:'daily', desc:'Play 5 Games', target:5, rwd:50, curr:'coins' },
        { id:'d2', type:'daily', desc:'Win 3 Hardcore', target:3, rwd:100, curr:'coins' },
        { id:'e1', type:'event', desc:'Collect 50 Crystals', target:50, rwd:10, curr:'tickets' },
        { id:'e2', type:'event', desc:'Win 5 Event Games', target:5, rwd:5, curr:'tickets' },
        { id:'l1', type:'lifetime', desc:'Reach Level 5', target:5, rwd:20, curr:'tickets' },
        { id:'l2', type:'lifetime', desc:'Win 100 Games', target:100, rwd:50, curr:'tickets' }
    ];
    
    const CALENDAR_REWARDS = [
        {t:'coins', v:50, i:'fa-coins'}, {t:'coins', v:100, i:'fa-coins'}, 
        {t:'crystals', v:5, i:'fa-bolt'}, {t:'coins', v:150, i:'fa-coins'}, 
        {t:'crystals', v:10, i:'fa-bolt'}, {t:'gems', v:5, i:'fa-gem'}, {t:'gems', v:15, i:'fa-gift'}
    ];
    
    const PASS_LEVELS = [
        { free:{t:'coins',v:50}, gold:{t:'item',v:'frame_neon'} }, 
        { free:{t:'item',v:'hint'}, gold:{t:'gems',v:10} }, 
        { free:{t:'coins',v:100}, gold:{t:'crystals',v:20} },
        { free:{t:'item',v:'freeze'}, gold:{t:'item',v:'badge_rich'} }, 
        { free:{t:'gems',v:5}, gold:{t:'coins',v:1000} },  
        { free:{t:'coins',v:200}, gold:{t:'item',v:'frame_magma'} }, 
        { free:{t:'item',v:'time'}, gold:{t:'gems',v:25} }, 
        { free:{t:'crystals',v:10}, gold:{t:'item',v:'badge_sniper'} }, 
        { free:{t:'gems',v:10}, gold:{t:'coins',v:2500} }, 
        { free:{t:'item',v:'xp_boost'}, gold:{t:'item',v:'frame_galaxy'} } 
    ];

    // --- STATE ---
    let state = {
        user: { name:'Guest', uid:null, avatarIdx:0, customAvatar:null, frame:null, theme:'', bio:'', setupComplete:false, goldPass:false, goldPassExpiry:0, goldTrialUsed:false, badges:[] },
        wallet: { coins:200, gems:5, crystals:0, tickets:0 }, 
        stats: { lvl:1, xp:0, wins:0, gamesPlayed:0, hardcoreWins:0 },
        inv: {}, missionProg: { e1:0, e2:0 }, 
        daily: { lastLogin:'', streak:0, lastSpin:0, lastEvent:'', lastCalClaim:0, lastMysteryBox:0 },
        pass: { claimed:[] }, 
        settings: { music:false, bgm:'1', darkMode:false, volume:0.5, haptics:true },
        tutorials: { home:false, shop:false, pass:false, profile:false },
        claimedMissions: []
    };
    
    let displayWallet = { coins:0, gems:0, crystals:0 };
    let tempAvatarIdx = 0, tempCustomAvatar = null, tempFrame = null;
    let audioCtx = null, currentGame = null, gameMode = 'classic', gameTimerInt = null, currentMissionTab = 'daily';
    let timerEndTime = 0, isFrozen = false;
    let currentShopTab = 'gifts';
    let activeGameSession = null; // Matches GameSession schema concept

    // --- AUDIO & HAPTICS ---
    function initAudio() { 
        if(!audioCtx) {
            audioCtx = new (window.AudioContext||window.webkitAudioContext)(); 
        }
        if(audioCtx.state === 'suspended') {
            audioCtx.resume();
        }
        updateAudioState(); 
    }
    
    function updateAudioState() {
        // Optimization: Stop all tracks efficiently
        ['1','2','3','4','5','6'].forEach(k=> { 
            const el = document.getElementById('bgMusic_'+k); 
            if(el) { 
                if(k !== state.settings.bgm || !state.settings.music) {
                    el.pause(); el.currentTime = 0; 
                }
            } 
        });
        
        document.getElementById('stMusic').innerText = state.settings.music ? 'ON' : 'OFF';
        
        if(state.settings.music) {
            if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
            const target = document.getElementById('bgMusic_'+state.settings.bgm);
            if(target && target.paused) { 
                target.volume = state.settings.volume; 
                target.play().catch(e => console.log("Audio play prevented:", e)); 
            }
        }
    }
    
    function toggleSetting(k) { 
        if(k==='music') { state.settings.music = !state.settings.music; initAudio(); } 
        if(k==='haptics') { state.settings.haptics = !state.settings.haptics; document.getElementById('stHaptics').innerText = state.settings.haptics ? 'ON' : 'OFF'; }
        saveData(); 
    }
    function changeBGM(v) { state.settings.bgm=v; updateAudioState(); saveData(); }
    function changeVol(v) { state.settings.volume=v; const target = document.getElementById('bgMusic_'+state.settings.bgm); if(target) target.volume = v; saveData(); }
    function triggerHaptic(forceStrong) { if(state.settings.haptics && navigator.vibrate) navigator.vibrate(forceStrong ? 200 : 50); }

    function randomWizAvatar() { tempAvatarIdx = Math.floor(Math.random()*AVATARS.length); document.getElementById('wizAvatar').src = `https://api.dicebear.com/9.x/adventurer/svg?seed=${AVATARS[tempAvatarIdx]}`; }
    function finishWizard(save) { if(save) { const n=document.getElementById('wizName').value; if(n) state.user.name=n; state.user.avatarIdx=tempAvatarIdx; } state.user.setupComplete=true; saveData(); renderAll(); document.getElementById('setupWizard').classList.add('hidden'); }

    // --- BATTLE PASS / GOLD PASS ---
    function checkGoldPass() {
        const now = Date.now();
        if(state.user.goldPass && now > state.user.goldPassExpiry) {
            state.user.goldPass = false; showToast("Gold Pass Expired", "error"); saveData();
        }
        if(state.user.goldPass) {
             const timeLeft = state.user.goldPassExpiry - now;
             const days = Math.floor(timeLeft / 86400000);
             const hours = Math.ceil((timeLeft % 86400000) / 3600000);
             document.getElementById('gpExpText').innerText = days > 0 ? `${days} Days Left` : `${hours} Hours Left`;
             document.getElementById('btnGoldPass').classList.add('hidden'); 
             document.getElementById('btnGoldTrial').classList.add('hidden');
        } else {
             document.getElementById('gpExpText').innerText = "Upgrade for Exclusive Rewards";
             document.getElementById('btnGoldPass').classList.remove('hidden');
             if(state.user.goldTrialUsed) document.getElementById('btnGoldTrial').classList.add('hidden');
             else document.getElementById('btnGoldTrial').classList.remove('hidden');
        }
        renderPass();
    }
    
    function buyGoldPass() {
        if(state.wallet.gems >= 100) {
            state.wallet.gems -= 100;
            state.user.goldPass = true;
            state.user.goldPassExpiry = Date.now() + 604800000; // 7 days
            saveData(); renderAll();
            showToast("Gold Pass Activated!", "success");
        } else { showToast("Need 100 Gems", "error"); }
    }

    function buyGoldTrial() {
        if(state.user.goldTrialUsed) return showToast("Trial already used", "error");
        if(state.wallet.gems >= 5) {
            state.wallet.gems -= 5;
            state.user.goldPass = true;
            state.user.goldPassExpiry = Date.now() + 21600000; // 6 hours
            state.user.goldTrialUsed = true;
            saveData(); renderAll();
            showToast("6h Trial Activated!", "success");
        } else { showToast("Need 5 Gems", "error"); }
    }

    function renderPass() {
        const track = document.getElementById('bpTrack'); track.innerHTML = '';
        const tickets = state.wallet.tickets || 0;
        document.getElementById('passTicketCount').innerText = tickets;
        const currentPassLvl = Math.floor(tickets / 5); 

        PASS_LEVELS.forEach((lvl, i) => {
            const idx = i + 1;
            const reached = currentPassLvl >= idx;
            const freeClaimed = state.pass.claimed.includes(`f${idx}`);
            const freeClass = freeClaimed ? 'claimed' : (reached ? 'ready' : 'locked');
            const freeIcon = lvl.free.t === 'item' ? '<i class="fa-solid fa-box"></i>' : (lvl.free.t==='coins'?'<i class="fa-solid fa-coins"></i>':'<i class="fa-solid fa-gem"></i>');
            const freeQty = (lvl.free.v > 1 && lvl.free.t !== 'item') ? `<span class="bp-qty">x${lvl.free.v}</span>` : '';
            
            const goldClaimed = state.pass.claimed.includes(`g${idx}`);
            const goldClass = goldClaimed ? 'claimed' : (reached && state.user.goldPass ? 'ready' : 'locked');
            const goldIcon = lvl.gold.t === 'item' ? '<i class="fa-solid fa-crown"></i>' : (lvl.gold.t==='crystals'?'<i class="fa-solid fa-bolt"></i>':'<i class="fa-solid fa-gem"></i>');
            const goldQty = (lvl.gold.v > 1 && lvl.gold.t !== 'item') ? `<span class="bp-qty">x${lvl.gold.v}</span>` : '';

            track.innerHTML += `
            <div class="bp-level">
                <div class="bp-reward-node ${goldClass} bp-gold-row" onclick="claimPassReward(${idx}, 'gold')">${goldIcon} ${goldQty}</div>
                <div style="width:2px; height:20px; background:var(--border);"></div>
                <div class="bp-reward-node ${freeClass}" onclick="claimPassReward(${idx}, 'free')">${freeIcon} ${freeQty}</div>
                <div style="font-size:10px; font-weight:bold; margin-top:5px;">Lvl ${idx}</div>
                <div style="font-size:9px; color:var(--text-muted);">(${idx*5} <i class="fa-solid fa-ticket-simple"></i>)</div>
            </div>`;
        });
    }

    function claimPassReward(lvl, type) {
        const tickets = state.wallet.tickets || 0;
        const currentPassLvl = Math.floor(tickets / 5);
        
        if(currentPassLvl < lvl) return showToast(`Need ${lvl*5} Tickets`, "error");
        if(type === 'gold' && !state.user.goldPass) return showToast("Buy Gold Pass", "error");
        
        const key = type.charAt(0) + lvl;
        if(state.pass.claimed.includes(key)) return;

        const reward = PASS_LEVELS[lvl-1][type];
        if(reward.t === 'item') {
            state.inv[reward.v] = (state.inv[reward.v]||0)+1;
            if(reward.v.includes('badge')) if(!state.user.badges.includes(reward.v)) state.user.badges.push(reward.v);
        } else {
            state.wallet[reward.t] += reward.v;
        }

        state.pass.claimed.push(key);
        showToast(`Claimed Level ${lvl} ${type}!`, "success");
        triggerHaptic(); saveData(); renderAll();
    }

    // --- GAMEPLAY & SCHEMA IMPLEMENTATION ---
    
    // Simulates creating a GameSession object for backend compliance
    function createGameSession(mode) {
        return {
            startTime: Date.now(),
            gameMode: mode,
            status: 'IN_PROGRESS',
            singlePlayerUser: state.user.uid, // Linking to User schema
            totalScore: 0
        };
    }

    function startGame(mode) {
        gameMode = mode; 
        currentGame = LOGOS[Math.floor(Math.random()*LOGOS.length)];
        activeGameSession = createGameSession(mode); // init session tracking

        document.getElementById('gameImg').src = `https://logo.clearbit.com/${currentGame.d}`;
        document.getElementById('gInput').value = '';
        document.getElementById('gameModeBadge').className = mode === 'hardcore' ? '' : 'hidden';
        document.getElementById('hardcoreTimer').className = mode === 'hardcore' ? 'timer-bar-bg' : 'hidden';
        document.getElementById('gameOverlay').style.opacity = '0'; 
        
        ['hint','freeze','time'].forEach(k => { document.getElementById('game'+k.charAt(0).toUpperCase()+k.slice(1)+'Count').innerText = state.inv[k] || 0; });

        openModal('gameModal');
        
        if(mode === 'hardcore') {
            // Optimization: Time based delta calculation instead of simple decrement to avoid drift
            isFrozen = false;
            timerEndTime = Date.now() + 20000; // 20 seconds from now
            document.getElementById('timerFill').style.width = '100%'; 
            clearInterval(gameTimerInt); 
            
            gameTimerInt = setInterval(() => {
                if(!isFrozen) {
                    const now = Date.now();
                    const left = timerEndTime - now;
                    let pct = (left / 20000) * 100;
                    
                    if (pct < 0) pct = 0;
                    document.getElementById('timerFill').style.width = pct + '%';

                    if(left <= 0){ 
                        endGame(false); 
                        showToast("Time's Up!", "error"); 
                        triggerHaptic(true); 
                    }
                } else {
                    // Extend end time while frozen so visual doesn't jump
                    timerEndTime += 100;
                }
            }, 100);
        }
    }

    function submitGuess() {
        const g = document.getElementById('gInput').value.trim().toLowerCase().replace(/[^a-z0-9]/g, '');
        const t = currentGame.n.toLowerCase().replace(/[^a-z0-9]/g, '');
        
        if(g === t) {
            let mult = state.user.goldPass ? 2 : 1;
            let xp = (gameMode==='classic'?100:20) * mult;
            let coins = (gameMode==='classic'?50:100) * mult;
            
            // Schema: Update session score
            if(activeGameSession) activeGameSession.totalScore += xp;

            if(gameMode==='hardcore') { 
                state.stats.hardcoreWins++; 
                state.wallet.crystals += (10 * mult); 
                state.missionProg['e2'] = (state.missionProg['e2']||0)+1; 
                state.missionProg['e1'] = (state.missionProg['e1']||0)+10; 
            } else { state.stats.wins++; }
            
            state.wallet.coins += coins; state.stats.gamesPlayed++;
            addXp(xp); updateMissionProg();
            
            document.getElementById('gameOverlay').style.opacity = '1';
            triggerHaptic();
            setTimeout(() => { endGame(true); showToast(`Correct! +${coins} Coins`, "success"); }, 1000);
        } else { showToast("Wrong!", "error"); triggerHaptic(true); }
    }
    
    function usePowerUp(type) {
        if((state.inv[type]||0) > 0) {
            state.inv[type]--;
            if(type === 'hint') document.getElementById('gInput').value = currentGame.n.substring(0, 2); 
            else if(type === 'freeze') { isFrozen = true; setTimeout(() => { isFrozen = false; }, 5000); showToast("Timer Frozen (5s)", "success"); }
            else if(type === 'time') { timerEndTime += 10000; showToast("+10s Added", "success"); }
            document.getElementById('game'+type.charAt(0).toUpperCase()+type.slice(1)+'Count').innerText = state.inv[type]; 
            saveData();
        } else { showToast("None left!", "error"); }
    }

    function endGame() { 
        clearInterval(gameTimerInt); 
        closeModal('gameModal'); 
        if(activeGameSession) activeGameSession.status = 'COMPLETED'; // Schema tracking
        saveData(); 
        renderAll(); 
    }
    
    function addXp(amount) {
        state.stats.xp += amount;
        if(state.stats.xp >= state.stats.lvl * 200) { state.stats.xp -= state.stats.lvl*200; state.stats.lvl++; showToast("Level Up!", "success"); triggerHaptic(true); }
    }
    function updateMissionProg() { saveData(); }

    // --- CLOUD (Updated for Schema) ---
    function saveScoreToCloud() {
        if(!state.user.uid) return;
        
        // Mapped to the provided Schema 'User' type
        const userPayload = {
            username: state.user.name,
            displayName: state.user.name,
            email: firebase.auth().currentUser ? firebase.auth().currentUser.email : "",
            photoUrl: state.user.customAvatar || "",
            totalScore: state.stats.xp,
            createdAt: firebase.firestore.FieldValue.serverTimestamp() // Assuming overwrite or merge handles existence
        };

        firebase.firestore().collection('User').doc(state.user.uid).set(userPayload, { merge: true })
        .catch(e => console.error("Cloud Sync Error", e));
    }

    function syncCloud(u) {
        state.user.uid = u.uid;
        document.getElementById('logoutBtnArea').classList.remove('hidden'); document.getElementById('loginArea').classList.add('hidden');
        saveData();
    }

    // --- RENDER ---
    function animateValue(id, start, end, duration) {
        const obj = document.getElementById(id);
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            obj.innerHTML = Math.floor(progress * (end - start) + start);
            if (progress < 1) { window.requestAnimationFrame(step); }
        };
        window.requestAnimationFrame(step);
    }

    function renderAll() {
        requestAnimationFrame(() => {
            // Rolling numbers logic
            ['Coins','Gems','Crystals'].forEach(k => {
                let key = k.toLowerCase();
                if(displayWallet[key] !== state.wallet[key]) {
                    animateValue('ui'+k, displayWallet[key], state.wallet[key], 1000);
                    displayWallet[key] = state.wallet[key];
                }
            });
            
            document.getElementById('profileName').innerText = state.user.name;
            
            // Gold Pass Visuals
            if(state.user.goldPass) {
                document.getElementById('profileName').classList.add('gold-nameplate');
                document.getElementById('profileAvatar').classList.add('gold-glow');
            } else {
                document.getElementById('profileName').classList.remove('gold-nameplate');
                document.getElementById('profileAvatar').classList.remove('gold-glow');
            }

            document.getElementById('profileBioDisplay').innerText = state.user.bio || "No bio yet.";
            const src = state.user.customAvatar ? state.user.customAvatar : `https://api.dicebear.com/9.x/adventurer/svg?seed=${AVATARS[state.user.avatarIdx]}`;
            document.getElementById('profileAvatar').src = src;
            
            const f = ITEMS.find(x => x.id === state.user.frame);
            document.getElementById('profileFrame').style.cssText = f ? `position:absolute; inset:-8px; border-radius:50%; z-index:2; pointer-events:none; ${f.css}` : '';
            
            const bDiv = document.getElementById('profileBadges'); bDiv.innerHTML = '';
            if(state.user.badges) state.user.badges.forEach(bid => { const b = ITEMS.find(i=>i.id===bid); if(b) bDiv.innerHTML+=`<i class="fa-solid ${b.icon}" style="color:var(--text); font-size:12px;" title="${b.n}"></i>`; });

            if(state.user.theme) document.body.setAttribute('data-theme', state.user.theme); else document.body.removeAttribute('data-theme');
            document.getElementById('stHaptics').innerText = state.settings.haptics ? 'ON' : 'OFF';

            document.getElementById('homeLvl').innerText = state.stats.lvl;
            document.getElementById('profileLvl').innerText = state.stats.lvl;
            document.getElementById('homeXpBar').style.width = Math.min((state.stats.xp/(state.stats.lvl*200))*100, 100) + '%';
            
            let rankObj = RANKS.reduce((p,c) => state.stats.hardcoreWins >= c.w ? c : p, RANKS[0]);
            document.getElementById('profileRank').innerText = rankObj.n;
            
            // Hardcore Progress Bar (Event Card)
            let nextRank = RANKS.find(r => r.w > state.stats.hardcoreWins);
            if(nextRank) {
                let prevRankW = rankObj.w;
                let progress = state.stats.hardcoreWins - prevRankW;
                let target = nextRank.w - prevRankW;
                let pct = Math.min((progress / target) * 100, 100);
                document.getElementById('hcProgressBar').style.width = pct + '%';
                document.getElementById('hcRankProgText').innerText = `${state.stats.hardcoreWins}/${nextRank.w}`;
            } else {
                document.getElementById('hcProgressBar').style.width = '100%';
                document.getElementById('hcRankProgText').innerText = 'MAX';
            }

            document.getElementById('statWins').innerText = state.stats.wins;
            document.getElementById('statHardWins').innerText = state.stats.hardcoreWins;
            document.getElementById('statXp').innerText = state.stats.xp;
            
            // Render Rank Modal List
            const rankListEl = document.getElementById('rankListContainer');
            rankListEl.innerHTML = '';
            RANKS.forEach(r => {
                let reached = state.stats.hardcoreWins >= r.w ? 'reached' : '';
                let icon = reached ? '<i class="fa-solid fa-check"></i>' : (r.w > state.stats.hardcoreWins ? `<i class="fa-solid fa-lock" style="opacity:0.5"></i>` : '');
                rankListEl.innerHTML += `<div class="rank-row ${reached}"><div>${r.n}</div><div>${r.w} Wins ${icon}</div></div>`;
            });

            renderMissions(); renderShop(); renderVaultModal(); checkGoldPass();
        });
    }

    function renderMissions() {
        const div = document.getElementById('missionList'); div.innerHTML = '';
        MISSIONS.filter(m => m.type === currentMissionTab).forEach(m => {
            let prog = 0;
            if(m.type === 'event') prog = state.missionProg[m.id] || 0; 
            if(m.id==='l1') prog = state.stats.lvl; if(m.id==='l2') prog = state.stats.wins+state.stats.hardcoreWins;
            if(m.type === 'daily' && m.id==='d1') prog = state.stats.gamesPlayed; 
            if(m.type === 'daily' && m.id==='d2') prog = state.stats.hardcoreWins;

            let icon = m.curr === 'tickets' ? '<i class="fa-solid fa-ticket-simple"></i>' : (m.curr==='coins'?'<i class="fa-solid fa-coins"></i>':'<i class="fa-solid fa-gem"></i>');
            let btn = state.claimedMissions.includes(m.id) ? '<i class="fa-solid fa-check"></i>' : (prog>=m.target ? `<button class="btn btn-sm btn-primary" onclick="claimMission('${m.id}'); triggerHaptic();">Claim</button>` : `${prog}/${m.target}`);
            div.innerHTML += `<div style="background:var(--card); padding:10px; border-radius:16px; border:1px solid var(--border); margin-bottom:8px; display:flex; justify-content:space-between; align-items:center;"><div style="font-size:12px;"><b>${m.desc}</b><br><span style="color:var(--text-muted)">${m.rwd} ${icon}</span></div><div>${btn}</div></div>`;
        });
    }

    // --- SHOP LOGIC ---
    function setShopTab(tab, el) {
        currentShopTab = tab;
        document.querySelectorAll('.shop-tab-btn').forEach(b => b.classList.remove('active'));
        if(el) el.classList.add('active');
        document.querySelectorAll('.shop-section').forEach(s => s.classList.add('hidden'));
        document.getElementById('shop-'+tab).classList.remove('hidden');
        renderShop();
    }
    
    function renderShopTabs() {
        setShopTab('gifts', document.querySelector('.shop-tab-btn'));
    }

    function renderShop() {
        // Clear sections
        ['shopRedeem','shopConsumables','shop-themes','shop-badges','shop-frames-grid'].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.innerHTML='';
        });
        
        // Items Logic
        ITEMS.forEach(i => {
            const owned = state.inv[i.id] || (i.type==='badge' && state.user.badges.includes(i.id)); 
            const locked = !owned && state.wallet[i.curr] < i.cost;
            const icon = i.curr === 'coins' ? 'fa-coins' : (i.curr==='crystals'?'fa-bolt':'fa-gem'); const color = i.curr === 'coins' ? 'var(--gold)' : (i.curr==='crystals'?'var(--crystal)':'var(--gem)');
            
            let previewBtn = i.type === 'frame' ? `<div class="preview-btn" onclick="event.stopPropagation(); previewItem('${i.id}')"><i class="fa-solid fa-eye"></i></div>` : '';

            let html = `<div class="item-box" onclick="buyItem('${i.id}')" style="opacity:${locked?0.7:1}"> ${previewBtn} ${owned ? '<div class="tag-owned"></div>' : ''} <i class="fa-solid ${i.icon||'fa-star'}" style="font-size:24px; color:var(--text-muted); margin-bottom:5px;"></i> <div style="font-size:11px; font-weight:700; margin-top:2px;">${i.n}</div> <div class="item-price"><i class="fa-solid ${icon}" style="color:${color}; font-size:9px;"></i> ${i.cost}</div> </div>`;
            
            if(i.type === 'frame') document.getElementById('shop-frames-grid').innerHTML+=html;
            else if(i.curr==='crystals') document.getElementById('shopRedeem').innerHTML+=html;
            else if(i.type==='consumable') document.getElementById('shopConsumables').innerHTML+=html;
            else if(i.type==='theme') document.getElementById('shop-themes').innerHTML+=html;
            else if(i.type==='badge') document.getElementById('shop-badges').innerHTML+=html;
        });

        // Mystery Box Timer
        const now = Date.now();
        const diff = now - state.daily.lastMysteryBox;
        const btn = document.getElementById('btnMystery');
        const txt = document.getElementById('mysteryTimer');
        if(diff > 86400000) {
            btn.disabled = false; btn.innerText = "Open Free (24h)"; btn.style.opacity = 1; txt.innerText = "Ready!";
        } else {
            btn.disabled = true; btn.style.opacity = 0.5;
            const left = 86400000 - diff;
            const h = Math.floor(left/3600000);
            txt.innerText = `Wait ${h}h`;
        }
    }

    function previewItem(id) {
        const i = ITEMS.find(x => x.id === id);
        if(!i) return;
        
        document.getElementById('prevTitle').innerText = i.n;
        document.getElementById('prevDesc').innerText = `Cost: ${i.cost} ${i.curr.toUpperCase()}`;
        document.getElementById('prevFrame').style.cssText = `position:absolute; inset:-8px; border-radius:50%; pointer-events:none; ${i.css}`;
        
        const btn = document.getElementById('prevBuyBtn');
        btn.onclick = () => { buyItem(id); closeModal('previewModal'); };
        
        openModal('previewModal');
    }

    function claimMysteryBox() {
        state.daily.lastMysteryBox = Date.now();
        const rand = Math.random();
        let msg = "";
        if(rand < 0.5) { state.wallet.coins += 100; msg = "100 Coins"; }
        else if(rand < 0.8) { state.wallet.gems += 5; msg = "5 Gems"; }
        else if(rand < 0.95) { state.inv['hint'] = (state.inv['hint']||0)+1; msg = "1 Hint Token"; }
        else { state.wallet.crystals += 10; msg = "10 Crystals!"; }
        
        showToast("Mystery Box: " + msg, "success");
        saveData(); renderAll();
    }
    
    function exchangeCurr(dir) {
        if(dir === 'c2g') {
            if(state.wallet.coins >= 1000) { state.wallet.coins -= 1000; state.wallet.gems += 10; showToast("Exchanged!", "success"); }
            else showToast("Need 1000 Coins", "error");
        } else {
            if(state.wallet.gems >= 10) { state.wallet.gems -= 10; state.wallet.coins += 500; showToast("Exchanged!", "success"); }
            else showToast("Need 10 Gems", "error");
        }
        saveData(); renderAll();
    }

    // --- ACTIONS ---
    function claimMission(id) { let m=MISSIONS.find(x=>x.id===id); state.wallet[m.curr]+=m.rwd; state.claimedMissions.push(id); showToast("Claimed!", "success"); saveData(); renderAll(); }
    function buyItem(id) { 
        let i=ITEMS.find(x=>x.id===id); 
        if(state.wallet[i.curr]>=i.cost) { 
            state.wallet[i.curr]-=i.cost; 
            if(i.type === 'badge') { if(!state.user.badges.includes(id)) { state.user.badges.push(id); showToast("Badge Added!", "success"); } else showToast("Already owned", "error"); }
            else { state.inv[id]=(state.inv[id]||0)+1; if(i.type === 'theme') { state.user.theme = i.val; showToast("Theme Applied!", "success"); } else showToast(`Bought ${i.n}`, "success"); }
            saveData(); renderAll(); triggerHaptic(); 
        } else { showToast("Need Funds", "error"); triggerHaptic(true); } 
    }
    function setMissionTab(t, el) { currentMissionTab=t; document.querySelectorAll('.mission-tab').forEach(x=>x.classList.remove('active')); el.classList.add('active'); renderMissions(); }

    // --- UTILS ---
    function showToast(msg, type) { 
        const t=document.createElement('div'); t.className=`toast`; 
        t.innerHTML = `<i class="fa-solid ${type==='error'?'fa-triangle-exclamation':'fa-circle-check'}" style="color:${type==='error'?'#ef4444':'#10b981'}; font-size:16px;"></i> <span style="flex:1">${msg}</span><div class="toast-progress"></div>`;
        if(type==='error') t.style.border='1px solid rgba(239, 68, 68, 0.4)'; else t.style.border='1px solid rgba(16, 185, 129, 0.4)';
        document.getElementById('toastContainer').appendChild(t); 
        triggerHaptic(type==='error'); setTimeout(()=>t.remove(),2600); 
    }
    
    function switchTab(id, el) { 
        document.querySelectorAll('.tab-view').forEach(t=>t.classList.add('hidden')); 
        document.getElementById('tab-'+id).classList.remove('hidden'); 
        document.querySelectorAll('.dock i').forEach(i=>i.classList.remove('active')); 
        el.classList.add('active'); 
        if(id==='shop') checkTutorial('shop');
        if(id==='pass') checkTutorial('pass');
        if(id==='profile') checkTutorial('profile');
        
        if(id==='home' || id==='shop') {
            const list = document.querySelector(`#tab-${id} .stagger-anim`);
            if(list) {
                list.style.display = 'none';
                setTimeout(() => list.style.display = (id==='shop' && currentShopTab!=='gifts' ? 'none' : 'block'), 10); 
            }
        }
    }
    
    function checkTutorial(id) {
        if (!state.tutorials[id]) {
            let tutId = 'tut' + id.charAt(0).toUpperCase() + id.slice(1);
            if(document.getElementById(tutId)) { setTimeout(() => openModal(tutId), 300); }
            state.tutorials[id] = true; saveData();
        }
    }

    function openModal(id) { document.getElementById(id).classList.add('open'); }
    function closeModal(id) { document.getElementById(id).classList.remove('open'); }
    
    // Auth & Edit Profile
    function openEditProfile() {
        tempAvatarIdx = state.user.avatarIdx; tempCustomAvatar = state.user.customAvatar; tempFrame = state.user.frame;
        document.getElementById('setupName').value = state.user.name;
        document.getElementById('setupBio').value = state.user.bio || '';
        updateSetupPreview(); renderFrameSelector();
        switchSetupTab('details', document.querySelector('.tab-btn'));
        openModal('setupModal');
    }
    function switchSetupTab(tabName, btn) { document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active')); document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); document.getElementById('setupTab-'+tabName).classList.add('active'); btn.classList.add('active'); triggerHaptic(); }
    function renderFrameSelector() {
        const div = document.getElementById('frameSelector');
        div.innerHTML = `<div class="item-box" onclick="selectFrame(null); triggerHaptic();" style="${!tempFrame?'border-color:var(--primary)':''}">None</div>`;
        ITEMS.filter(i => i.type === 'frame').forEach(i => {
            if(state.inv[i.id]) div.innerHTML += `<div class="item-box" onclick="selectFrame('${i.id}'); triggerHaptic();" style="${tempFrame===i.id?'border-color:var(--primary)':''}"> <div style="width:20px; height:20px; border-radius:50%; ${i.css}"></div> <div style="font-size:10px; margin-top:5px;">${i.n}</div> </div>`;
        });
    }
    function selectFrame(id) { tempFrame = id; renderFrameSelector(); }
    function changeAvatar(d) { tempAvatarIdx+=d; if(tempAvatarIdx<0) tempAvatarIdx=AVATARS.length-1; if(tempAvatarIdx>=AVATARS.length) tempAvatarIdx=0; tempCustomAvatar=null; updateSetupPreview(); }
    function handleImageUpload(input) { if (input.files && input.files[0]) { if(input.files[0].size > 500000) return alert("File too large"); var r=new FileReader(); r.onload=function(e){tempCustomAvatar=e.target.result; updateSetupPreview();}; r.readAsDataURL(input.files[0]); } }
    function updateSetupPreview() { document.getElementById('setupAvatarPreview').src = tempCustomAvatar ? tempCustomAvatar : `https://api.dicebear.com/9.x/adventurer/svg?seed=${AVATARS[tempAvatarIdx]}`; }
    function saveProfile() { if(document.getElementById('setupName').value) state.user.name=document.getElementById('setupName').value; state.user.bio=document.getElementById('setupBio').value; state.user.avatarIdx=tempAvatarIdx; state.user.customAvatar=tempCustomAvatar; state.user.frame=tempFrame; saveData(); closeModal('setupModal'); renderAll(); }

    function googleLogin() { const p=new firebase.auth.GoogleAuthProvider(); firebase.auth().signInWithPopup(p).then(()=>{closeModal('authModal');showToast("Welcome!","success")}).catch(e=>showToast(e.message,"error")); }
    function showEmailForm() { document.getElementById('authMenu').classList.add('hidden'); document.getElementById('emailForm').classList.remove('hidden'); }
    function hideEmailForm() { document.getElementById('emailForm').classList.add('hidden'); document.getElementById('authMenu').classList.remove('hidden'); }
    function emailAuth(type) { const e=document.getElementById('authEmail').value,p=document.getElementById('authPass').value; const a=firebase.auth(); const pr=type==='signup'?a.createUserWithEmailAndPassword(e,p):a.signInWithEmailAndPassword(e,p); pr.then(()=>{closeModal('authModal');showToast("Success!","success")}).catch(r=>showToast(r.message,"error")); }
    
    function saveData() { try{localStorage.setItem('guessit_v140e_opt', JSON.stringify(state)); if(state.user.uid) saveScoreToCloud();}catch(e){} }
    function loadData() { const d=localStorage.getItem('guessit_v140e_opt'); if(d) { state={...state, ...JSON.parse(d)}; if(state.user.theme) document.body.setAttribute('data-theme',state.user.theme); if(state.settings.darkMode) document.body.classList.add('dark-mode'); } }
    function resetData() { localStorage.removeItem('guessit_v140e_opt'); window.location.reload(); }
    function toggleDarkMode() { document.body.classList.toggle('dark-mode'); state.settings.darkMode=!state.settings.darkMode; saveData(); }
    
    // --- EXTRAS ---
    function checkCalendar() { 
        openModal('calendarModal'); 
        const g=document.getElementById('calGrid'); g.innerHTML='';
        for(let i=0; i<7; i++) {
            let rwd = CALENDAR_REWARDS[i];
            let status = i < state.daily.streak ? 'claimed' : (i===state.daily.streak ? 'active' : '');
            g.innerHTML += `<div class="cal-day ${status}">
                <div style="font-weight:bold; font-size:9px; color:var(--text-muted);">Day ${i+1}</div>
                <i class="fa-solid ${rwd.i}" style="color:${status==='active'?'white':(rwd.t==='coins'?'var(--gold)':'var(--gem)')}"></i>
                <div style="font-weight:800;">${rwd.v}</div>
            </div>`;
        }
    }
    
    function claimCalendar() { 
        const now=Date.now(); 
        if(now-state.daily.lastCalClaim>86400000){ 
            if(state.daily.streak >= 7) state.daily.streak = 0; 
            const reward = CALENDAR_REWARDS[state.daily.streak];
            state.wallet[reward.t] += reward.v;
            state.daily.streak++; state.daily.lastCalClaim=now; 
            showToast(`Claimed ${reward.v} ${reward.t.toUpperCase()}!`, "success"); 
            saveData(); checkCalendar(); renderAll();
        } else { showToast("Come back tomorrow", "error"); triggerHaptic(true); }
    }
    
    function spinWheel() { 
        const now=Date.now(); 
        if(now-state.daily.lastSpin>3600000){ 
            state.daily.lastSpin=now; 
            const totalDeg = 1800 + Math.floor(Math.random() * 360); 
            const segmentIndex = Math.floor(((360 - (totalDeg % 360)) % 360) / 60);
            const prizes = [{t:'gems',v:1,n:'1 GEM'},{t:'gems',v:3,n:'3 GEMS'},{t:'coins',v:20,n:'20 COINS'},{t:'coins',v:50,n:'50 COINS'},{t:'gems',v:5,n:'5 GEMS'},{t:'coins',v:100,n:'100 COINS'}];
            const prize = prizes[segmentIndex];
            document.getElementById('theWheel').style.transform=`rotate(${totalDeg}deg)`; 
            setTimeout(()=>{ 
                state.wallet[prize.t] += prize.v;
                showToast(`Won ${prize.n}!`, "success"); 
                saveData(); renderAll(); closeModal('spinnerModal'); triggerHaptic(); 
                setTimeout(() => document.getElementById('theWheel').style.transform = 'rotate(0deg)', 500);
            }, 4000); 
        } else { showToast("Wait 1 hour", "error"); triggerHaptic(true); } 
    }
    
    function eventCheckIn() { const t=new Date().toDateString(); if(state.daily.lastEvent!==t){ state.daily.lastEvent=t; state.wallet.crystals+=5; showToast("+5 Crystals","success"); saveData(); renderAll(); } else { showToast("Already Checked In","error"); triggerHaptic(true); }}
    
    function renderVaultModal() {
        const grid = document.getElementById('invGrid'); grid.innerHTML = '';
        if(state.wallet.tickets > 0) grid.innerHTML += `<div class="item-box"><i class="fa-solid fa-ticket-simple" style="margin-bottom:5px; color:var(--text-muted);"></i><div>Tickets</div><div style="font-size:10px; color:var(--text-muted)">x${state.wallet.tickets}</div></div>`;
        Object.keys(state.inv).forEach(k => {
            if(state.inv[k] > 0) { const item = ITEMS.find(x => x.id === k); if(item) grid.innerHTML += `<div class="item-box"><i class="fa-solid ${item.icon||'fa-box'}" style="margin-bottom:5px;"></i><div>${item.n}</div><div style="font-size:10px; color:var(--text-muted)">x${state.inv[k]}</div></div>`; }
        });
        if(grid.innerHTML === '') grid.innerHTML = '<div style="grid-column:span 3; color:var(--text-muted); font-size:11px;">Vault is empty.</div>';
    }
  </script>
</body>
</html>